<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KMart POS Invoice Generator (Simple Excel)</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        h2, h3 {
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }
        input, button {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border: 1px solid #ccc;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .input-group > div {
            flex: 1;
        }
        .autocomplete-list {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            max-height: 200px;
            overflow-y: auto;
            width: calc(100% - 22px);
            z-index: 1000;
        }
        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .autocomplete-item:hover {
            background-color: #f0f0f0;
        }
        #resultDisplay {
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }
        #message {
            margin-top: 10px;
            padding: 10px;
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            border-radius: 4px;
        }
        #localCartDisplay {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
        }
        .cart-item:last-child {
            border-bottom: none;
        }
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        .bill-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        .bill-table th, .bill-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .bill-table th {
            background-color: #f2f2f2;
        }
        .bill-table .item-name {
            text-align: left;
        }
        .total-row td {
            font-weight: bold;
            background-color: #e0e0e0;
        }
        .footer-text-html {
            text-align: center;
            font-weight: bold;
            font-size: 16pt;
            margin-top: 5px;
        }
    </style>
</head>
<body onload="loadItemData()">

    <div class="container">
        <h2>üõçÔ∏è KMart Vegetable POS Utility</h2>
        <div id="message">Loading item data...</div>

        <h3>Add Item to Cart</h3>
        <div style="position: relative;">
            <input type="text" id="searchInput" placeholder="Search by Code or Item Name" oninput="handleSearchInput()">
            <div id="autocompleteList" class="autocomplete-list"></div>
        </div>
        <div id="resultDisplay"></div>
        
        <div class="input-group">
            <div><input type="number" id="qtyInput" placeholder="QTY (e.g., 2.5)"></div>
            <div><input type="number" id="totalInput" placeholder="TOTAL Price (e.g., 50.00)"></div>
        </div>

        <button id="addButton" onclick="addItemToCart()" disabled>Add to Cart</button>

        <h3>Current Cart (Items: <span id="cartCount">0</span>)</h3>
        <div id="localCartDisplay"></div>
        
        <div class="action-buttons">
            <button onclick="clearLocalCart()" style="background-color: #dc3545;">Clear Cart</button>
            <button id="viewBillButton" onclick="viewLocalCartHTML()" disabled style="background-color: #ffc107; color: #333;">View Bill (On Screen)</button>
        </div>
        
        <button id="downloadXLSXButton" onclick="downloadSimpleXLSX()" disabled style="background-color: #28a745; margin-top: 10px;">Download Cart as Simple XLSX</button>

        <div id="billViewArea" style="display: none; margin-top: 30px;">
            <h3>Bill Preview</h3>
            <div id="billContent"></div>
        </div>
    </div>

    <script>
        // CONFIG
        const CART_STORAGE_KEY = 'kmartLocalCart';

        // STATE
        let allItemData = [];
        let selectedItem = null;

        // --- LOCAL STORAGE UTILITIES ---
        function loadLocalCart() {
            const storedCart = localStorage.getItem(CART_STORAGE_KEY);
            return storedCart ? JSON.parse(storedCart) : {};
        }

        function saveLocalCart(cartData) {
            localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cartData));
        }

        // --- INITIAL LOAD ---
        async function loadItemData() {
            try {
                const itemResponse = await fetch('./items.json'); 
                allItemData = await itemResponse.json();
                
                document.getElementById('message').textContent = 'Data loaded. Add items to cart.';
            } catch (e) {
                console.error("Error loading JSON file:", e);
                document.getElementById('message').textContent =
                    'Error loading item data. Check items.json file.';
            }
            renderCart();
        }
        
        // --- SEARCH AND SELECTION LOGIC (Unchanged) ---
        function handleSearchInput() {
            const searchInput = document.getElementById('searchInput');
            const listDiv = document.getElementById('autocompleteList');
            const messageEl = document.getElementById('message');
            const searchText = searchInput.value.trim().toLowerCase();

            selectedItem = null;
            document.getElementById('resultDisplay').style.display = 'none';
            document.getElementById('addButton').disabled = true;

            listDiv.style.display = 'none';
            listDiv.innerHTML = "";

            if (searchText.length < 3) {
                messageEl.textContent = 'Type at least 3 characters.';
                return;
            }

            const searchParts = searchText.split(/\s+/).filter(p => p.length > 0);
            const results = [];

            for (const data of allItemData) {
                const itemName = (data.item || "").toLowerCase();
                const code = String(data.code || "");
                const combined = `${itemName} ${code}`;

                const match = searchParts.every(part => combined.includes(part));
                if (match) {
                    results.push(data);
                    if (results.length >= 20) break;
                }
            }

            if (results.length > 0) {
                results.forEach(suggestion => {
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item';
                    div.innerHTML = `<strong>${suggestion.code}</strong> - ${suggestion.item}`;
                    div.onclick = () => {
                        searchInput.value = `${suggestion.code} ${suggestion.item}`;
                        selectedItem = suggestion;
                        listDiv.style.display = 'none';
                        showSelectedItem();
                    };
                    listDiv.appendChild(div);
                });
                listDiv.style.display = 'block';
            }

            messageEl.textContent = `Found ${results.length} items.`;
        }

        function showSelectedItem() {
            if (selectedItem) {
                const display = document.getElementById('resultDisplay');
                display.innerHTML = `CODE: ${selectedItem.code} | ITEM: ${selectedItem.item}`;
                display.style.display = 'block';

                document.getElementById('addButton').disabled = false;
                document.getElementById('message').textContent = 'Item Selected. Enter Qty/Total.';
            }
        }

        // --- LOCAL CART LOGIC (Unchanged) ---
        function renderCart() {
            const localCart = loadLocalCart();
            const items = Object.values(localCart);
            const cartDisplay = document.getElementById('localCartDisplay');
            const cartCount = document.getElementById('cartCount');
            const downloadButton = document.getElementById('downloadXLSXButton');
            const viewBillButton = document.getElementById('viewBillButton');

            cartCount.textContent = items.length;
            downloadButton.disabled = (items.length === 0);
            viewBillButton.disabled = (items.length === 0);

            if (items.length === 0) {
                document.getElementById('billViewArea').style.display = 'none';
                cartDisplay.innerHTML = 'Cart is empty. Add items above.';
                return;
            }

            cartDisplay.innerHTML = "";
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'cart-item';
                div.innerHTML = `
                    <span>${item.item} (Row: ${item.row})</span>
                    <span>Qty: ${item.qty} | Total: ${item.total}</span>
                `;
                cartDisplay.appendChild(div);
            });
        }

        function clearLocalCart() {
            if (confirm("Are you sure you want to clear the entire cart and start a new invoice?")) {
                localStorage.removeItem(CART_STORAGE_KEY);
                renderCart();
                document.getElementById('message').textContent = 'Cart cleared. Ready for new invoice.';
                document.getElementById('searchInput').value = '';
                document.getElementById('qtyInput').value = '';
                document.getElementById('totalInput').value = '';
                document.getElementById('resultDisplay').style.display = 'none';
                document.getElementById('billViewArea').style.display = 'none';
            }
        }

        function addItemToCart() {
            if (!selectedItem) {
                alert('Please select an item first.');
                return;
            }

            const qtyStr = document.getElementById('qtyInput').value.trim();
            const totalStr = document.getElementById('totalInput').value.trim();

            const numQty = parseFloat(qtyStr);
            const numTotal = parseFloat(totalStr);

            if (isNaN(numQty) || isNaN(numTotal) || numQty <= 0) {
                alert('Please enter valid QTY and TOTAL values.');
                return;
            }

            const localCart = loadLocalCart();

            const cartItem = {
                row: selectedItem.row,
                qty: numQty,
                total: numTotal,
                item: selectedItem.item
            };

            localCart[selectedItem.row] = cartItem;
            saveLocalCart(localCart);

            document.getElementById('qtyInput').value = "";
            document.getElementById('totalInput').value = "";
            document.getElementById('searchInput').value = "";
            document.getElementById('resultDisplay').style.display = 'none';
            document.getElementById('addButton').disabled = true;
            selectedItem = null;

            renderCart();
            document.getElementById('message').textContent =
                `Item added to local storage. (${cartItem.item})`;
        }

        // --- VIEW BILL (ON SCREEN) (Unchanged) ---
        function viewLocalCartHTML() {
            const localCart = loadLocalCart();
            const items = Object.values(localCart);
            const billViewArea = document.getElementById('billViewArea');
            const billContent = document.getElementById('billContent');
            const now = new Date();
            
            if (items.length === 0) {
                billContent.innerHTML = "<p>Cart is empty. Add items to view the bill.</p>";
                billViewArea.style.display = 'block';
                return;
            }

            let tableHTML = `
                <table class="bill-table">
                    <thead>
                        <tr>
                            <th>CODE</th>
                            <th class="item-name">ITEM NAME</th>
                            <th>QTY</th>
                            <th>Rate</th>
                            <th>RATE.inc</th>
                            <th>TOTAL</th>
                            <th>ItemBarCode</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let grandTotal = 0;
            
            items.forEach((item) => {
                const itemDetails = allItemData.find((d) => d.row === item.row);
                const itemCode = itemDetails ? String(itemDetails.code || "") : "";
                const paddedCode = itemCode.padStart(4, '0');
                const itemBarcode = itemCode ? `9900${paddedCode}000000` : "";

                const qty = item.qty;
                const total = item.total;
                const rateInc = qty > 0 ? total / qty : 0;
                const rateExcl = rateInc / 1.05;

                grandTotal += total;

                tableHTML += `
                    <tr>
                        <td>${itemCode}</td>
                        <td class="item-name">${item.item}</td>
                        <td>${qty.toFixed(2)}</td>
                        <td>${rateExcl.toFixed(3)}</td>
                        <td>${rateInc.toFixed(3)}</td>
                        <td>${total.toFixed(2)}</td>
                        <td>${itemBarcode}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    <tr class="total-row">
                        <td colspan="5" style="text-align: right;">GRAND TOTAL:</td>
                        <td style="text-align: center;">${grandTotal.toFixed(2)}</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td colspan="7" style="height: 15px;"></td> </tr>
                    </tbody>
                </table>
                <br>
                <div class="footer-text-html">KMART SUPERMARKET LLC</div>
                <div class="footer-text-html" style="font-size: 14pt; font-weight: normal;">Branch: Burdubai (Al Raffa)</div>
                <div class="footer-text-html" style="font-size: 14pt; font-weight: normal;">Date: ${now.toLocaleDateString("en-GB")}</div>
                <div class="footer-text-html" style="font-size: 14pt; font-weight: normal;">Vegetable and Fruits Invoice</div>
            `;

            billContent.innerHTML = tableHTML;
            billViewArea.style.display = 'block';
            document.getElementById('message').textContent = 'Bill displayed below.';
        }


        // -------------------------------------------------------------------
        // ‚úÖ NEW: Simple Self Excel Creation Function (Array-Based)
        // -------------------------------------------------------------------
        function downloadSimpleXLSX() {
            const XLSX = window.XLSX;
            if (!XLSX) {
                alert("XLSX library is not loaded.");
                return;
            }

            const localCart = loadLocalCart();
            const items = Object.values(localCart);
            if (items.length === 0) {
                alert("Cart is empty");
                return;
            }

            let grandTotal = 0;
            const now = new Date();
            
            // 1. Define the entire data structure as an Array of Arrays (AoA)
            const exportData = [];
            
            // --- 1st Row: Headings ---
            exportData.push([
                "CODE",
                "ITEM NAME",
                "QTY",
                "Rate",
                "RATE.inc",
                "TOTAL",
                "ItemBarCode"
            ]);

            // --- 2nd Row to N: Item Data ---
            items.forEach((item) => {
                const itemDetails = allItemData.find((d) => d.row === item.row);
                const itemCode = itemDetails ? String(itemDetails.code || "") : "";
                const paddedCode = itemCode.padStart(4, '0');
                const itemBarcode = itemCode ? `9900${paddedCode}000000` : "";

                const qty = item.qty;
                const total = item.total;
                const rateInc = qty > 0 ? total / qty : 0;
                const rateExcl = rateInc / 1.05;

                grandTotal += total;

                exportData.push([
                    itemCode,
                    item.item,
                    qty,
                    Number(rateExcl.toFixed(3)),
                    Number(rateInc.toFixed(3)),
                    total,
                    itemBarcode
                ]);
            });

            // Calculate the last item row index (for Grand Total formula)
            const lastDataRowExcel = exportData.length; // Excel rows start at 1

            // --- (N+1) Row: Grand Total ---
            // We use a blank cell for F (Total) and then add the formula post-AoA conversion
            exportData.push([
                "GRAND TOTAL:",
                "",
                "",
                "",
                "",
                "", // This will hold the formula
                ""
            ]);
            
            // --- (N+2) Row: Blank Row ---
            exportData.push(["", "", "", "", "", "", ""]);

            // --- (N+3) to (N+6) Rows: Footer Details ---
            exportData.push([
                "KMART SUPERMARKET LLC",
                "Branch: Burdubai (Al Raffa)",
                `Date: ${now.toLocaleDateString("en-GB")}`,
                "Vegetable and Fruits Invoice",
                "", "", "" // Padding to make it a 7-column array
            ]);


            // 2. Convert AoA to Worksheet
            const ws = XLSX.utils.aoa_to_sheet(exportData);

            // 3. Add the Grand Total Formula to the correct cell (F column)
            const grandTotalRowIndex = lastDataRowExcel; // 0-indexed
            const grandTotalCellAddress = XLSX.utils.encode_cell({ r: grandTotalRowIndex, c: 5 }); // F column (index 5)

            // F2:F[lastDataRowExcel] is the range of item totals
            const totalFormula = `SUM(F2:F${lastDataRowExcel})`;
            
            // Find the cell created by aoa_to_sheet and update it
            if (ws[grandTotalCellAddress]) {
                ws[grandTotalCellAddress].f = totalFormula;
                ws[grandTotalCellAddress].t = 'n'; // Ensure type is number for formula
                ws[grandTotalCellAddress].v = grandTotal; // Set current value as fallback
                ws[grandTotalCellAddress].z = "#,##0.00"; // Format the cell
            } else {
                // If it wasn't created (e.g., if array had sparse data), create it
                XLSX.utils.sheet_add_aoa(ws, [
                    [{ f: totalFormula, v: grandTotal, z: "#,##0.00", t: 'n' }]
                ], { origin: grandTotalCellAddress });
            }


            // 4. Create Workbook and Download
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Invoice");

            const filename =
                `INVOICE_SIMPLE_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, "0")}${String(now.getDate()).padStart(2, "0")}_${String(now.getHours()).padStart(2, "0")}${String(now.getMinutes()).padStart(2, "0")}.xlsx`;

            XLSX.writeFile(wb, filename);
            document.getElementById('message').textContent = `Downloaded: ${filename}. Simple XLSX file created successfully.`;
        }
    </script>
</body>
</html>
