<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>KMART Invoice</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; background:#f4f4f4; padding:20px; }
.container { max-width:420px; margin:auto; background:white; padding:20px; border-radius:8px; }
input, button { width:100%; padding:10px; margin-bottom:12px; font-size:16px; }
button { color:white; border:none; border-radius:4px; cursor:pointer; }
#addButton { background:#28a745; }
#downloadXLSXButton { background:#007bff; }
.autocomplete-list { border:1px solid #ccc; max-height:200px; overflow-y:auto; background:white; position:absolute; width:100%; display:none; }
.autocomplete-item { padding:10px; border-bottom:1px solid #eee; cursor:pointer; }
.autocomplete-item:hover { background:#f0f0f0; }
.cart-item { display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px dashed #ccc; }
</style>
</head>

<body>
<div class="container">

<h2 style="text-align:center;">KMART AL RAFFA</h2>
<hr>

<label>Search Item</label>
<input type="text" id="searchInput" onkeyup="searchItem()" autocomplete="off">
<div id="autocompleteList" class="autocomplete-list"></div>

<div id="selectedBox" style="background:#e0f7fa; padding:10px; display:none;"></div>

<label>Qty</label>
<input type="number" id="qtyInput">

<label>Total</label>
<input type="number" id="totalInput">

<button id="addButton" onclick="addToCart()" disabled>Add to Cart</button>

<h3>Cart (<span id="cartCount">0</span>)</h3>
<div id="cartBox" style="background:#fff3e0; padding:10px;"></div>

<button id="downloadXLSXButton" onclick="downloadXLSX()" disabled>Download XLSX</button>

</div>

<script>

let allItemData = [];
let selectedItem = null;
let cart = {};

// ✅ FETCH items.json
fetch("fetch("https://raw.githubusercontent.com/kmartalraffa/invoice_mob/main/items.json")
")
  .then(res => res.json())
  .then(data => {
    allItemData = data;
    console.log("Items loaded:", allItemData.length);
  })
  .catch(err => {
    alert("Error loading items.json");
    console.error(err);
  });

function searchItem() {
  const text = document.getElementById("searchInput").value.toLowerCase();
  const list = document.getElementById("autocompleteList");
  list.innerHTML = "";
  list.style.display = "none";
  selectedItem = null;
  document.getElementById("addButton").disabled = true;

  if (text.length < 2) return;

  const results = allItemData.filter(x =>
    x.item.toLowerCase().includes(text) || String(x.code).includes(text)
  );

  if (results.length === 0) return;

  results.forEach(r => {
    const div = document.createElement("div");
    div.className = "autocomplete-item";
    div.innerHTML = `<b>${r.code}</b> - ${r.item}`;
    div.onclick = () => {
      selectedItem = r;
      document.getElementById("searchInput").value = r.code + " " + r.item;
      list.style.display = "none";
      showSelected();
    };
    list.appendChild(div);
  });

  list.style.display = "block";
}

function showSelected() {
  const box = document.getElementById("selectedBox");
  box.innerHTML = `Selected: <b>${selectedItem.code}</b> - ${selectedItem.item}`;
  box.style.display = "block";
  document.getElementById("addButton").disabled = false;
}

function addToCart() {
  const qty = parseFloat(document.getElementById("qtyInput").value);
  const total = parseFloat(document.getElementById("totalInput").value);

  if (!selectedItem || qty <= 0 || total <= 0) {
    alert("Enter valid qty & total");
    return;
  }

  cart[selectedItem.row] = {
    row: selectedItem.row,
    code: selectedItem.code,
    item: selectedItem.item,
    qty: qty,
    total: total
  };

  renderCart();

  document.getElementById("qtyInput").value = "";
  document.getElementById("totalInput").value = "";
  document.getElementById("searchInput").value = "";
  document.getElementById("selectedBox").style.display = "none";
  selectedItem = null;
  document.getElementById("addButton").disabled = true;
}

function renderCart() {
  const box = document.getElementById("cartBox");
  box.innerHTML = "";
  const items = Object.values(cart);

  document.getElementById("cartCount").innerText = items.length;
  document.getElementById("downloadXLSXButton").disabled = items.length === 0;

  items.forEach(i => {
    const div = document.createElement("div");
    div.className = "cart-item";
    div.innerHTML = `<span>${i.item}</span><span>${i.qty} | ${i.total}</span>`;
    box.appendChild(div);
  });
}

// ✅ XLSX DOWNLOAD
function downloadXLSX() {

  const items = Object.values(cart);
  if (items.length === 0) return;

  const now = new Date();
  const dd = String(now.getDate()).padStart(2,'0');
  const mm = String(now.getMonth()+1).padStart(2,'0');
  const yyyy = now.getFullYear();
  const dateText = `${dd}/${mm}/${yyyy}`;
  const fileDate = `${dd}-${mm}-${yyyy}`;

  const wb = XLSX.utils.book_new();
  const ws = {};

  ws['!cols'] = [
    {wch:10},{wch:30},{wch:10},{wch:10},{wch:10},{wch:20},{wch:10}
  ];

  ws['!merges'] = [
    {s:{r:0,c:0}, e:{r:0,c:6}},
    {s:{r:1,c:0}, e:{r:1,c:6}},
    {s:{r:2,c:0}, e:{r:2,c:6}}
  ];

  const border = {top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};
  const center = {horizontal:"center",vertical:"center"};

  ws['A1'] = {v:"KMART SUPERMARKET LLC [AL RAFFA]", s:{font:{sz:18,bold:true},alignment:center,border:border}};
  ws['A2'] = {v:"VEGETABLE AND FRUITS INVOICE", s:{font:{sz:14,bold:true},alignment:center,border:border}};
  ws['A3'] = {v:"DATE: "+dateText, s:{font:{sz:14,bold:true},alignment:center,border:border}};

  const headers = ["CODE","ITEM NAME","QTY","RATE INC","TOTAL","ItemBarCode","Rate"];
  headers.forEach((h,i)=>{
    ws[XLSX.utils.encode_cell({r:3,c:i})] = {
      v:h,
      s:{font:{bold:true},alignment:center,border:border,fill:{fgColor:{rgb:"FFF2F2F2"}}}
    };
  });

  let row = 4;
  let grand = 0;

  items.forEach(it=>{
    const rateInc = it.total / it.qty;
    const rateEx = rateInc / 1.05;
    const barcode = `9900${it.code}000000`;

    const rowData = [
      it.code,
      it.item,
      it.qty,
      rateInc.toFixed(3),
      it.total,
      barcode,
      rateEx.toFixed(3)
    ];

    rowData.forEach((v,i)=>{
      ws[XLSX.utils.encode_cell({r:row,c:i})] = {
        v:v,
        s:{alignment:center,border:border,font:{sz:12}}
      };
    });

    grand += it.total;
    row++;
  });

  ws['!merges'].push(
    {s:{r:row,c:0}, e:{r:row,c:3}},
    {s:{r:row,c:4}, e:{r:row,c:6}}
  );

  ws['A'+(row+1)] = {v:"GRAND TOTAL", s:{font:{sz:18,bold:true},alignment:center,border:border}};
  ws['E'+(row+1)] = {v:grand, s:{font:{sz:18,bold:true},alignment:center,border:border}};

  XLSX.utils.book_append_sheet(wb, ws, "INVOICE");
  XLSX.writeFile(wb, `${fileDate} invoice.xlsx`);
}

</script>
</body>
</html>