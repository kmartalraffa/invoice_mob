<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KMart POS Invoice Generator</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        h2, h3 {
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }
        input, button {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border: 1px solid #ccc;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .input-group > div {
            flex: 1;
        }
        .autocomplete-list {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            max-height: 200px;
            overflow-y: auto;
            width: calc(100% - 22px);
            z-index: 1000;
        }
        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .autocomplete-item:hover {
            background-color: #f0f0f0;
        }
        #resultDisplay {
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }
        #message {
            margin-top: 10px;
            padding: 10px;
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            border-radius: 4px;
        }
        #localCartDisplay {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
        }
        .cart-item:last-child {
            border-bottom: none;
        }
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        .bill-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        .bill-table th, .bill-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .bill-table th {
            background-color: #f2f2f2;
        }
        .bill-table .item-name {
            text-align: left;
        }
        .total-row td {
            font-weight: bold;
            background-color: #e0e0e0;
        }
        .footer-text-html {
            text-align: center;
            font-weight: bold;
            font-size: 16pt;
            margin-top: 5px;
        }
    </style>
</head>
<body onload="loadItemData()">

    <div class="container">
        <h2>üõçÔ∏è KMart Vegetable POS Utility</h2>
        <div id="message">Loading item data...</div>

        <h3>Add Item to Cart</h3>
        <div style="position: relative;">
            <input type="text" id="searchInput" placeholder="Search by Code or Item Name" oninput="handleSearchInput()">
            <div id="autocompleteList" class="autocomplete-list"></div>
        </div>
        <div id="resultDisplay"></div>
        
        <div class="input-group">
            <div><input type="number" id="qtyInput" placeholder="QTY (e.g., 2.5)"></div>
            <div><input type="number" id="totalInput" placeholder="TOTAL Price (e.g., 50.00)"></div>
        </div>

        <button id="addButton" onclick="addItemToCart()" disabled>Add to Cart</button>

        <h3>Current Cart (Items: <span id="cartCount">0</span>)</h3>
        <div id="localCartDisplay"></div>
        
        <div class="action-buttons">
            <button onclick="clearLocalCart()" style="background-color: #dc3545;">Clear Cart</button>
            <button id="viewBillButton" onclick="viewLocalCartHTML()" disabled style="background-color: #ffc107; color: #333;">View Bill (On Screen)</button>
        </div>
        
        <button id="downloadXLSXButton" onclick="downloadLocalCartXLSX()" disabled style="background-color: #28a745; margin-top: 10px;">Download Cart as XLSX</button>

        <div id="billViewArea" style="display: none; margin-top: 30px;">
            <h3>Bill Preview</h3>
            <div id="billContent"></div>
        </div>
    </div>

    <script>
        // CONFIG
        const CART_STORAGE_KEY = 'kmartLocalCart';
        const TEMPLATE_FILE = './template.xlsx'; // Path to your template file

        // STATE
        let allItemData = [];
        let selectedItem = null;

        // --- LOCAL STORAGE UTILITIES ---
        function loadLocalCart() {
            const storedCart = localStorage.getItem(CART_STORAGE_KEY);
            return storedCart ? JSON.parse(storedCart) : {};
        }

        function saveLocalCart(cartData) {
            localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cartData));
        }

        // --- INITIAL LOAD ---
        async function loadItemData() {
            try {
                const itemResponse = await fetch('./items.json'); 
                allItemData = await itemResponse.json();

                const checkTemplate = await fetch(TEMPLATE_FILE, { method: 'HEAD' });
                if (!checkTemplate.ok) {
                    document.getElementById('message').textContent = 'Error: template.xlsx not found!';
                    return;
                }
                
                document.getElementById('message').textContent = 'Data loaded. Template ready. Add items to cart.';
            } catch (e) {
                console.error("Error loading JSON files or template:", e);
                document.getElementById('message').textContent =
                    'Error loading item data or template. Check files.';
            }
            renderCart();
        }
        
        // --- SEARCH AND SELECTION LOGIC ---
        function handleSearchInput() {
            const searchInput = document.getElementById('searchInput');
            const listDiv = document.getElementById('autocompleteList');
            const messageEl = document.getElementById('message');
            const searchText = searchInput.value.trim().toLowerCase();

            selectedItem = null;
            document.getElementById('resultDisplay').style.display = 'none';
            document.getElementById('addButton').disabled = true;

            listDiv.style.display = 'none';
            listDiv.innerHTML = "";

            if (searchText.length < 3) {
                messageEl.textContent = 'Type at least 3 characters.';
                return;
            }

            const searchParts = searchText.split(/\s+/).filter(p => p.length > 0);
            const results = [];

            for (const data of allItemData) {
                const itemName = (data.item || "").toLowerCase();
                const code = String(data.code || "");
                const combined = `${itemName} ${code}`;

                const match = searchParts.every(part => combined.includes(part));
                if (match) {
                    results.push(data);
                    if (results.length >= 20) break;
                }
            }

            if (results.length > 0) {
                results.forEach(suggestion => {
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item';
                    div.innerHTML = `<strong>${suggestion.code}</strong> - ${suggestion.item}`;
                    div.onclick = () => {
                        searchInput.value = `${suggestion.code} ${suggestion.item}`;
                        selectedItem = suggestion;
                        listDiv.style.display = 'none';
                        showSelectedItem();
                    };
                    listDiv.appendChild(div);
                });
                listDiv.style.display = 'block';
            }

            messageEl.textContent = `Found ${results.length} items.`;
        }

        function showSelectedItem() {
            if (selectedItem) {
                const display = document.getElementById('resultDisplay');
                display.innerHTML = `CODE: ${selectedItem.code} | ITEM: ${selectedItem.item}`;
                display.style.display = 'block';

                document.getElementById('addButton').disabled = false;
                document.getElementById('message').textContent = 'Item Selected. Enter Qty/Total.';
            }
        }

        // --- LOCAL CART LOGIC ---
        function renderCart() {
            const localCart = loadLocalCart();
            const items = Object.values(localCart);
            const cartDisplay = document.getElementById('localCartDisplay');
            const cartCount = document.getElementById('cartCount');
            const downloadButton = document.getElementById('downloadXLSXButton');
            const viewBillButton = document.getElementById('viewBillButton');

            cartCount.textContent = items.length;
            downloadButton.disabled = (items.length === 0);
            viewBillButton.disabled = (items.length === 0);

            if (items.length === 0) {
                document.getElementById('billViewArea').style.display = 'none';
                cartDisplay.innerHTML = 'Cart is empty. Add items above.';
                return;
            }

            cartDisplay.innerHTML = "";
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'cart-item';
                div.innerHTML = `
                    <span>${item.item} (Row: ${item.row})</span>
                    <span>Qty: ${item.qty} | Total: ${item.total}</span>
                `;
                cartDisplay.appendChild(div);
            });
        }

        function clearLocalCart() {
            if (confirm("Are you sure you want to clear the entire cart and start a new invoice?")) {
                localStorage.removeItem(CART_STORAGE_KEY);
                renderCart();
                document.getElementById('message').textContent = 'Cart cleared. Ready for new invoice.';
                document.getElementById('searchInput').value = '';
                document.getElementById('qtyInput').value = '';
                document.getElementById('totalInput').value = '';
                document.getElementById('resultDisplay').style.display = 'none';
                document.getElementById('billViewArea').style.display = 'none';
            }
        }


        function addItemToCart() {
            if (!selectedItem) {
                alert('Please select an item first.');
                return;
            }

            const qtyStr = document.getElementById('qtyInput').value.trim();
            const totalStr = document.getElementById('totalInput').value.trim();

            const numQty = parseFloat(qtyStr);
            const numTotal = parseFloat(totalStr);

            if (isNaN(numQty) || isNaN(numTotal) || numQty <= 0) {
                alert('Please enter valid QTY and TOTAL values.');
                return;
            }

            const localCart = loadLocalCart();

            const cartItem = {
                row: selectedItem.row,
                qty: numQty,
                total: numTotal,
                item: selectedItem.item
            };

            localCart[selectedItem.row] = cartItem;
            saveLocalCart(localCart);

            document.getElementById('qtyInput').value = "";
            document.getElementById('totalInput').value = "";
            document.getElementById('searchInput').value = "";
            document.getElementById('resultDisplay').style.display = 'none';
            document.getElementById('addButton').disabled = true;
            selectedItem = null;

            renderCart();
            document.getElementById('message').textContent =
                `Item added to local storage. (${cartItem.item})`;
        }

        // --- VIEW BILL (ON SCREEN) ---
        function viewLocalCartHTML() {
            const localCart = loadLocalCart();
            const items = Object.values(localCart);
            const billViewArea = document.getElementById('billViewArea');
            const billContent = document.getElementById('billContent');
            const now = new Date();
            
            if (items.length === 0) {
                billContent.innerHTML = "<p>Cart is empty. Add items to view the bill.</p>";
                billViewArea.style.display = 'block';
                return;
            }

            let tableHTML = `
                <table class="bill-table">
                    <thead>
                        <tr>
                            <th>CODE</th>
                            <th class="item-name">ITEM NAME</th>
                            <th>QTY</th>
                            <th>Rate</th>
                            <th>RATE.inc</th>
                            <th>TOTAL</th>
                            <th>ItemBarCode</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let grandTotal = 0;
            
            items.forEach((item) => {
                const itemDetails = allItemData.find((d) => d.row === item.row);
                const itemCode = itemDetails ? String(itemDetails.code || "") : "";
                const paddedCode = itemCode.padStart(4, '0');
                const itemBarcode = itemCode ? `9900${paddedCode}000000` : "";

                const qty = item.qty;
                const total = item.total;
                const rateInc = qty > 0 ? total / qty : 0;
                const rateExcl = rateInc / 1.05;

                grandTotal += total;

                tableHTML += `
                    <tr>
                        <td>${itemCode}</td>
                        <td class="item-name">${item.item}</td>
                        <td>${qty.toFixed(2)}</td>
                        <td>${rateExcl.toFixed(3)}</td>
                        <td>${rateInc.toFixed(3)}</td>
                        <td>${total.toFixed(2)}</td>
                        <td>${itemBarcode}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    <tr class="total-row">
                        <td colspan="5" style="text-align: right;">GRAND TOTAL:</td>
                        <td style="text-align: center;">${grandTotal.toFixed(2)}</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td colspan="7" style="height: 15px;"></td> </tr>
                    </tbody>
                </table>
                <br>
                <div class="footer-text-html">KMART SUPERMARKET LLC</div>
                <div class="footer-text-html" style="font-size: 14pt; font-weight: normal;">Branch: Burdubai (Al Raffa)</div>
                <div class="footer-text-html" style="font-size: 14pt; font-weight: normal;">Date: ${now.toLocaleDateString("en-GB")}</div>
                <div class="footer-text-html" style="font-size: 14pt; font-weight: normal;">Vegetable and Fruits Invoice</div>
            `;

            billContent.innerHTML = tableHTML;
            billViewArea.style.display = 'block';
            document.getElementById('message').textContent = 'Bill displayed below.';
        }


        // -------------------------------------------------------------------
        // ‚úÖ FINAL CORRECTED UTILITY FUNCTION (Includes Row Metadata Fix)
        // -------------------------------------------------------------------
        function shiftTemplateRows(ws, itemsCount) {
            
            // Row 3 in Excel (0-indexed 2)
            const START_ROW_TO_SHIFT = 2; 
            // Row 7 in Excel (0-indexed 6)
            const END_ROW_TO_SHIFT = 6; 
            
            // Shift for Grand Total
            const grandTotalShiftAmount = itemsCount;
            // Shift for Footer Details (+1 for the blank row)
            const footerDetailShiftAmount = itemsCount + 1; 

            if (itemsCount === 0) return;

            const colsToMove = ['A', 'B', 'C', 'D', 'E', 'F', 'G'];
            
            let originalMerges = ws['!merges'] || [];
            
            // Ensure !rows is initialized for metadata manipulation
            if (!ws['!rows']) ws['!rows'] = [];

            
            // --- 1. Shift the Footer Details Block (Rows 4-7) ---
            for (let r = END_ROW_TO_SHIFT; r >= START_ROW_TO_SHIFT + 1; r--) {
                const originalRowExcel = r + 1; 
                const newRowExcel = r + 1 + footerDetailShiftAmount;

                colsToMove.forEach(col => {
                    const originalCellAddress = col + originalRowExcel;
                    const newCellAddress = col + newRowExcel;

                    const originalCell = ws[originalCellAddress];
                    if (originalCell) {
                        ws[newCellAddress] = JSON.parse(JSON.stringify(originalCell));
                        delete ws[originalCellAddress];
                    }
                });

                // --- FIX: Transfer and DELETE old row metadata for cleanliness ---
                if (ws['!rows'][r]) {
                    // Transfer the row metadata (e.g., height)
                    if (!ws['!rows'][r + footerDetailShiftAmount]) ws['!rows'][r + footerDetailShiftAmount] = {};
                    Object.assign(ws['!rows'][r + footerDetailShiftAmount], ws['!rows'][r]);
                    // Delete the original metadata entry to prevent 's' error
                    delete ws['!rows'][r]; 
                }
            }


            // --- 2. Shift the Grand Total Row (Row 3) ---
            {
                const r = START_ROW_TO_SHIFT;
                const originalRowExcel = r + 1; 
                const newRowExcel = r + 1 + grandTotalShiftAmount;

                colsToMove.forEach(col => {
                    const originalCellAddress = col + originalRowExcel;
                    const newCellAddress = col + newRowExcel;

                    const originalCell = ws[originalCellAddress];
                    if (originalCell) {
                        ws[newCellAddress] = JSON.parse(JSON.stringify(originalCell));
                        delete ws[originalCellAddress];
                    }
                });
                
                // --- FIX: Transfer and DELETE old row metadata for cleanliness ---
                if (ws['!rows'][r]) {
                    if (!ws['!rows'][r + grandTotalShiftAmount]) ws['!rows'][r + grandTotalShiftAmount] = {};
                    Object.assign(ws['!rows'][r + grandTotalShiftAmount], ws['!rows'][r]);
                    delete ws['!rows'][r]; // Delete the original metadata entry
                }
            }


            // 3. Clear the original footer cell data (Rows 3-7) 
            for (let r = START_ROW_TO_SHIFT; r <= END_ROW_TO_SHIFT; r++) {
                const originalRowExcel = r + 1;
                colsToMove.forEach(col => {
                    delete ws[col + originalRowExcel];
                });
            }

            // 4. Rebuild Merges with shifted rows AND add the new BLANK ROW merge
            ws['!merges'] = [];
            
            // *** ADD MERGE FOR THE BLANK ROW ***
            const blankRowIndex = START_ROW_TO_SHIFT + grandTotalShiftAmount; 
            const blankMergeRange = `A${blankRowIndex + 1}:G${blankRowIndex + 1}`; 
            
            // Push the merge as a decoded range object
            ws['!merges'].push(XLSX.utils.decode_range(blankMergeRange));


            originalMerges.forEach(mergeRange => {
                // FIX: Ensure the merge object is decoded before manipulation
                const rangeAddress = typeof mergeRange === 'object' ? XLSX.utils.encode_range(mergeRange) : mergeRange;
                const range = XLSX.utils.decode_range(rangeAddress);
                
                // Apply the correct shift
                if (range.s.r === START_ROW_TO_SHIFT) { // Grand Total merge (Row 3)
                    range.s.r += grandTotalShiftAmount;
                    range.e.r += grandTotalShiftAmount;
                } else if (range.s.r >= START_ROW_TO_SHIFT + 1 && range.s.r <= END_ROW_TO_SHIFT) { // Footer Detail merges (Rows 4-7)
                    range.s.r += footerDetailShiftAmount;
                    range.e.r += footerDetailShiftAmount;
                }
                
                // Push the shifted merge
                ws['!merges'].push(XLSX.utils.encode_range(range));
            });


            // 5. Update the Grand Total Formula 
            const grandTotalRowIndex = START_ROW_TO_SHIFT + grandTotalShiftAmount; 
            const grandTotalCellAddress = `F${grandTotalRowIndex + 1}`; 

            if (ws[grandTotalCellAddress]) {
                const lastDataRowExcel = 1 + itemsCount;
                ws[grandTotalCellAddress].f = `SUM(F2:F${lastDataRowExcel})`;
                ws[grandTotalCellAddress].t = 'n';
                ws[grandTotalCellAddress].z = "#,##0.00";
            }

            // 6. Update the worksheet's dimensions
            const range = XLSX.utils.decode_range(ws['!ref']);
            const finalRowIndex = END_ROW_TO_SHIFT + footerDetailShiftAmount;
            if (finalRowIndex > range.e.r) {
                range.e.r = finalRowIndex;
                ws['!ref'] = XLSX.utils.encode_range(range);
            }
        }


        // -------------------------------------------------------------------
        // TEMPLATE-BASED DOWNLOAD FUNCTION 
        // -------------------------------------------------------------------
        async function downloadLocalCartXLSX() {
            const XLSX = window.XLSX;

            if (!XLSX) {
                alert("XLSX library not loaded");
                return;
            }

            const localCart = loadLocalCart();
            const items = Object.values(localCart);
            if (items.length === 0) {
                alert("Cart is empty");
                return;
            }

            // 1. Fetch the template file
            let rawData;
            try {
                const response = await fetch(TEMPLATE_FILE);
                if (!response.ok) {
                    throw new Error(`Failed to fetch template: ${response.statusText}`);
                }
                rawData = await response.arrayBuffer();
            } catch (e) {
                alert("Error loading template.xlsx. Please ensure the file exists and is uploaded as a proper XLSX file.");
                console.error(e);
                return;
            }

            // 2. Read the template Workbook
            const wb = XLSX.read(rawData, { type: 'array' });
            const sheetName = wb.SheetNames[0];
            const ws = wb.Sheets[sheetName];

            // 3. Prepare the new data
            const dataRows = [];

            items.forEach((item) => {
                const itemDetails = allItemData.find((d) => d.row === item.row);
                const itemCode = itemDetails ? String(itemDetails.code || "") : "";
                const paddedCode = itemCode.padStart(4, '0');
                const itemBarcode = itemCode ? `9900${paddedCode}000000` : "";

                const qty = item.qty;
                const total = item.total;
                const rateInc = qty > 0 ? total / qty : 0;
                const rateExcl = rateInc / 1.05;

                dataRows.push([
                    itemCode,
                    item.item,
                    qty,
                    { v: Number(rateExcl.toFixed(3)), t: "n", z: "0.000" },
                    { v: Number(rateInc.toFixed(3)), t: "n", z: "0.000" },
                    { v: total, t: "n", z: "#,##0.00" },
                    itemBarcode
                ]);
            });

            // 4. Shift the existing footer rows down BEFORE inserting data
            shiftTemplateRows(ws, items.length);

            // 5. Add new data to the worksheet starting from A2 (Row 2, which is now empty)
            XLSX.utils.sheet_add_aoa(
                ws,
                dataRows,
                {
                    origin: "A2",
                    skipHeader: true,
                    cellStyles: true 
                }
            );

            // 6. Apply robust style to inserted data (ensuring row height and formatting are consistent)
            const startRow = 2;
            const lastDataRow = 1 + items.length;

            const baseCellStyle = {
                font: { sz: 16, name: "Arial" },
                alignment: { vertical: "center" }
            };

            if (!ws['!rows']) ws['!rows'] = [];

            for (let r = startRow; r <= lastDataRow; r++) {
                const rowIdx = r - 1; 

                if (!ws['!rows'][rowIdx]) ws['!rows'][rowIdx] = {};
                ws['!rows'][rowIdx].hpt = 22; // Set standard row height

                for (let c = 0; c <= 6; c++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: rowIdx, c: c });
                    const cell = ws[cellAddress];

                    if (cell) {
                        let currentStyle = JSON.parse(JSON.stringify(baseCellStyle));

                        // Alignment logic
                        if (c === 0 || c === 2 || c === 6) { 
                            currentStyle.alignment.horizontal = "center";
                        } else if (c === 1) { 
                            currentStyle.alignment.horizontal = "left";
                        } else { 
                            currentStyle.alignment.horizontal = "center";
                        }

                        // Number formatting logic
                        if (cell.t === 'n') {
                            if (c === 3 || c === 4) { 
                                currentStyle.numFmt = "0.000";
                            } else if (c === 5) { 
                                currentStyle.numFmt = "#,##0.00";
                            } else {
                                currentStyle.numFmt = cell.z || "General";
                            }
                        } else {
                            delete currentStyle.numFmt;
                        }

                        cell.s = currentStyle;
                    }
                }
            }


            // 7. Write/Download the new file
            const now = new Date();
            const filename =
                `INVOICE_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, "0")}${String(now.getDate()).padStart(2, "0")}_${String(now.getHours()).padStart(2, "0")}${String(now.getMinutes()).padStart(2, "0")}.xlsx`;

            XLSX.writeFile(wb, filename);
            document.getElementById('message').textContent = `Downloaded: ${filename}. Please confirm the Excel structure is perfect now.`;
        }
    </script>
</body>
</html>
