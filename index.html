<script>
    // CONFIG
    const CART_STORAGE_KEY = 'kmartLocalCart';
    const TEMPLATE_FILE = './template.xlsx'; // Path to your template file

    // STATE
    let allItemData = [];
    let selectedItem = null;

    // --- LOCAL STORAGE UTILITIES (Unchanged) ---
    function loadLocalCart() {
      const storedCart = localStorage.getItem(CART_STORAGE_KEY);
      return storedCart ? JSON.parse(storedCart) : {};
    }

    function saveLocalCart(cartData) {
      localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cartData));
    }

    // --- INITIAL LOAD (Unchanged) ---
    async function loadItemData() {
      try {
        const itemResponse = await fetch('./items.json');
        allItemData = await itemResponse.json();

        const checkTemplate = await fetch(TEMPLATE_FILE, { method: 'HEAD' });
        if (!checkTemplate.ok) {
            document.getElementById('message').textContent = 'Error: template.xlsx not found!';
            return;
        }
        
        document.getElementById('message').textContent = 'Data loaded. Template ready.';
      } catch (e) {
        console.error("Error loading JSON files or template:", e);
        document.getElementById('message').textContent =
          'Error loading item data or template. Check files.';
      }
      renderCart();
    }
    
    // --- SEARCH AND SELECTION LOGIC (Unchanged) ---
    function handleSearchInput() {
      const searchInput = document.getElementById('searchInput');
      const listDiv = document.getElementById('autocompleteList');
      const messageEl = document.getElementById('message');
      const searchText = searchInput.value.trim().toLowerCase();

      selectedItem = null;
      document.getElementById('resultDisplay').style.display = 'none';
      document.getElementById('addButton').disabled = true;

      listDiv.style.display = 'none';
      listDiv.innerHTML = "";

      if (searchText.length < 3) {
        messageEl.textContent = 'Type at least 3 characters.';
        return;
      }

      const searchParts = searchText.split(/\s+/).filter(p => p.length > 0);
      const results = [];

      for (const data of allItemData) {
        const itemName = (data.item || "").toLowerCase();
        const code = String(data.code || "");
        const combined = `${itemName} ${code}`;

        const match = searchParts.every(part => combined.includes(part));
        if (match) {
          results.push(data);
          if (results.length >= 20) break;
        }
      }

      if (results.length > 0) {
        results.forEach(suggestion => {
          const div = document.createElement('div');
          div.className = 'autocomplete-item';
          div.innerHTML = `<strong>${suggestion.code}</strong> - ${suggestion.item}`;
          div.onclick = () => {
            searchInput.value = `${suggestion.code} ${suggestion.item}`;
            selectedItem = suggestion;
            listDiv.style.display = 'none';
            showSelectedItem();
          };
          listDiv.appendChild(div);
        });
        listDiv.style.display = 'block';
      }

      messageEl.textContent = `Found ${results.length} items.`;
    }

    function showSelectedItem() {
      if (selectedItem) {
        const display = document.getElementById('resultDisplay');
        display.innerHTML = `CODE: ${selectedItem.code} | ITEM: ${selectedItem.item}`;
        display.style.display = 'block';

        document.getElementById('addButton').disabled = false;
        document.getElementById('message').textContent = 'Item Selected. Enter Qty/Total.';
      }
    }

    // --- LOCAL CART LOGIC (Unchanged) ---
    function renderCart() {
      const localCart = loadLocalCart();
      const items = Object.values(localCart);
      const cartDisplay = document.getElementById('localCartDisplay');
      const cartCount = document.getElementById('cartCount');
      const downloadButton = document.getElementById('downloadXLSXButton');

      cartCount.textContent = items.length;
      downloadButton.disabled = (items.length === 0);

      if (items.length === 0) {
        cartDisplay.innerHTML = 'Cart is empty. Add items above.';
        return;
      }

      cartDisplay.innerHTML = "";
      items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'cart-item';
        div.innerHTML = `
          <span>${item.item} (Row: ${item.row})</span>
          <span>Qty: ${item.qty} | Total: ${item.total}</span>
        `;
        cartDisplay.appendChild(div);
      });
    }

    function addItemToCart() {
      if (!selectedItem) {
        alert('Please select an item first.');
        return;
      }

      const qtyStr = document.getElementById('qtyInput').value.trim();
      const totalStr = document.getElementById('totalInput').value.trim();

      const numQty = parseFloat(qtyStr);
      const numTotal = parseFloat(totalStr);

      if (isNaN(numQty) || isNaN(numTotal) || numQty <= 0) {
        alert('Please enter valid QTY and TOTAL values.');
        return;
      }

      const localCart = loadLocalCart();

      const cartItem = {
        row: selectedItem.row,
        qty: numQty,
        total: numTotal,
        item: selectedItem.item
      };

      localCart[selectedItem.row] = cartItem;
      saveLocalCart(localCart);

      document.getElementById('qtyInput').value = "";
      document.getElementById('totalInput').value = "";
      document.getElementById('searchInput').value = "";
      document.getElementById('resultDisplay').style.display = 'none';
      document.getElementById('addButton').disabled = true;
      selectedItem = null;

      renderCart();
      document.getElementById('message').textContent =
        `Item added to local storage. (${cartItem.item})`;
    }


  // -------------------------------------------------------------------
  // ✅ TEMPLATE-BASED DOWNLOAD FUNCTION (MODIFIED)
  // -------------------------------------------------------------------
  async function downloadLocalCartXLSX() {
    const XLSX = window.XLSX; 

    if (!XLSX) {
      alert("XLSX library not loaded");
      return;
    }

    const localCart = loadLocalCart();
    const items = Object.values(localCart);
    if (items.length === 0) {
      alert("Cart is empty");
      return;
    }

    // 1. Fetch the template file
    let rawData;
    try {
        const response = await fetch(TEMPLATE_FILE);
        if (!response.ok) {
            throw new Error(`Failed to fetch template: ${response.statusText}`);
        }
        rawData = await response.arrayBuffer();
    } catch (e) {
        alert("Error loading template.xlsx. Please ensure the file exists.");
        console.error(e);
        return;
    }

    // 2. Read the template Workbook
    const wb = XLSX.read(rawData, { type: 'array' });
    const sheetName = wb.SheetNames[0]; 
    const ws = wb.Sheets[sheetName];

    // 3. Prepare the new data
    const dataRows = [];
    const now = new Date();

    items.forEach((item) => {
      const itemDetails = allItemData.find((d) => d.row === item.row);
      const itemCode = itemDetails ? String(itemDetails.code || "") : "";
      const itemBarcode = itemCode ? `9900${itemCode}000000` : "";

      const qty = item.qty;
      const total = item.total;
      const rateInc = qty > 0 ? total / qty : 0; 
      const rateExcl = rateInc / 1.05;

      // Ensure the order matches the template's columns (A-G)
      dataRows.push([
        itemCode,
        item.item,
        qty,
        { v: Number(rateExcl.toFixed(3)), t: "n", z: "0.000" },
        { v: Number(rateInc.toFixed(3)), t: "n", z: "0.000" },
        { v: total, t: "n", z: "#,##0.00" },
        itemBarcode
      ]);
    });

    // 4. Add new data to the worksheet starting from A2
    // ✅ FIX: Use skipHeader: true to prevent adding item array header
    XLSX.utils.sheet_add_aoa(
        ws, 
        dataRows, 
        { 
            origin: "A2", 
            skipHeader: true, // This skips the automatic header creation
            cellStyles: true 
        } 
    ); 

    // 5. Update the Grand Total Formula
    const newLastDataRow = 1 + items.length;
    const assumedGtRow = newLastDataRow + 1;
    
    // Update the GT formula based on the new last row (F column)
    const gtAddress = `F${assumedGtRow}`; 
    if (ws[gtAddress]) {
        ws[gtAddress].f = `SUM(F2:F${newLastDataRow})`;
    }
    
    // 6. Write/Download the new file
    const filename =
      `INVOICE_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, "0")}${String(now.getDate()).padStart(2, "0")}_${String(now.getHours()).padStart(2, "0")}${String(now.getMinutes()).padStart(2, "0")}.xlsx`;

    XLSX.writeFile(wb, filename);
    document.getElementById('message').textContent = `Downloaded: ${filename}`;
  }
  </script>
