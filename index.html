<!DOCTYPE html>
<html>
<head>
Â  <meta charset="UTF-8">
Â  <title>Shop Invoice - kmart alraffa (Offline Cart)</title>
Â  <meta name="viewport" content="width=device-width, initial-scale=1">
Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

Â  <style>
Â  Â  /* CSS remains the same */
Â  Â  body {
Â  Â  Â  font-family: Arial, sans-serif;
Â  Â  Â  padding: 20px;
Â  Â  Â  background-color: #f4f4f4;
Â  Â  }
Â  Â  .container {
Â  Â  Â  max-width: 400px;
Â  Â  Â  margin: auto;
Â  Â  Â  background: white;
Â  Â  Â  padding: 20px;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
Â  Â  }
Â  Â  input[type="text"],
Â  Â  input[type="number"] {
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 10px;
Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  box-sizing: border-box;
Â  Â  Â  font-size: 16px;
Â  Â  }
Â  Â  button {
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 10px;
Â  Â  Â  color: white;
Â  Â  Â  border: none;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-size: 16px;
Â  Â  Â  margin-bottom: 15px;
Â  Â  }
Â  Â  button:hover:enabled {
Â  Â  Â  opacity: 0.9;
Â  Â  }
Â  Â  button:disabled {
Â  Â  Â  background-color: #cccccc !important;
Â  Â  Â  cursor: not-allowed;
Â  Â  }
Â  Â  h1 {
Â  Â  Â  text-align: center;
Â  Â  Â  color: #333;
Â  Â  Â  margin-bottom: 5px;
Â  Â  }
Â  Â  h2 {
Â  Â  Â  text-align: center;
Â  Â  Â  color: #666;
Â  Â  Â  margin-top: 0;
Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  font-size: 18px;
Â  Â  }
Â  Â  h3 {
Â  Â  Â  margin-top: 15px;
Â  Â  Â  margin-bottom: 10px;
Â  Â  }
Â  Â  .result-box {
Â  Â  Â  background-color: #e0f7fa;
Â  Â  Â  padding: 10px;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  font-weight: bold;
Â  Â  }
Â  Â  .cart-box {
Â  Â  Â  background-color: #fff3e0;
Â  Â  Â  padding: 10px;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  margin-bottom: 20px;
Â  Â  }
Â  Â  .search-area {
Â  Â  Â  position: relative;
Â  Â  }
Â  Â  .autocomplete-list {
Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  max-height: 200px;
Â  Â  Â  overflow-y: auto;
Â  Â  Â  position: absolute;
Â  Â  Â  width: 100%;
Â  Â  Â  background: white;
Â  Â  Â  z-index: 10;
Â  Â  Â  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
Â  Â  }
Â  Â  .autocomplete-item {
Â  Â  Â  padding: 10px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  border-bottom: 1px solid #eee;
Â  Â  }
Â  Â  .autocomplete-item:hover {
Â  Â  Â  background-color: #f0f0f0;
Â  Â  }
Â  Â  .label-style {
Â  Â  Â  font-weight: bold;
Â  Â  Â  margin-bottom: 5px;
Â  Â  Â  display: block;
Â  Â  }

Â  Â  /* Buttons */
Â  Â  #addButton {
Â  Â  Â  background-color: #4CAF50;
Â  Â  }
Â  Â  #downloadXLSXButton {
Â  Â  Â  background-color: #007bff;
Â  Â  Â  margin-bottom: 15px;
Â  Â  }
Â  Â  #viewBillButton {
Â  Â  Â  background-color: #ff9800;
Â  Â  Â  margin-bottom: 15px;
Â  Â  }

Â  Â  .cart-item {
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  padding: 5px 0;
Â  Â  Â  border-bottom: 1px dashed #ccc;
Â  Â  Â  font-size: 14px;
Â  Â  }
Â  Â  .cart-item:last-child {
Â  Â  Â  border-bottom: none;
Â  Â  }
Â  Â Â 
Â  Â  /* Bill View Styling */
Â  Â  .bill-table {Â 
Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  border-collapse: collapse;Â 
Â  Â  Â  Â  font-size: 16pt;Â 
Â  Â  Â  Â  margin-top: 20px;Â 
Â  Â  }
Â  Â  .bill-table th {Â 
Â  Â  Â  Â  font-size: 14pt;Â 
Â  Â  Â  Â  border-bottom: 2px solid #333;Â 
Â  Â  Â  Â  padding: 5px;Â 
Â  Â  Â  Â  text-align: center;Â 
Â  Â  Â  Â  background-color: #f2f2f2;Â 
Â  Â  }
Â  Â  .bill-table td {Â 
Â  Â  Â  Â  padding: 8px;Â 
Â  Â  Â  Â  text-align: center;Â 
Â  Â  Â  Â  border-bottom: 1px dashed #ccc;Â 
Â  Â  }
Â  Â  .bill-table .item-name {Â 
Â  Â  Â  Â  text-align: left;Â 
Â  Â  }
Â  Â  .bill-table .total-row td {Â 
Â  Â  Â  Â  font-weight: bold;Â 
Â  Â  Â  Â  border-top: 2px solid #333;Â 
Â  Â  Â  Â  font-size: 16pt;Â 
Â  Â  Â  Â  padding-top: 10px;Â 
Â  Â  }
Â  Â  .footer-text-html {Â 
Â  Â  Â  Â  text-align: center;Â 
Â  Â  Â  Â  font-weight: bold;Â 
Â  Â  Â  Â  padding: 5px;Â 
Â  Â  Â  Â  margin-top: 10px;Â 
Â  Â  }
Â  </style>
</head>

<body onload="loadItemData()">
Â  <div class="container">
Â  Â  <h1>Shop Invoice</h1>
Â  Â  <h2>kmart alraffa</h2>
Â  Â  <hr>

Â  Â  <div class="search-area">
Â  Â  Â  <label for="searchInput" class="label-style">1. ITEM CODE OR NAME :</label>
Â  Â  Â  <input
Â  Â  Â  Â  type="text"
Â  Â  Â  Â  id="searchInput"
Â  Â  Â  Â  placeholder="Type to search and click an item"
Â  Â  Â  Â  onkeyup="handleSearchInput()"
Â  Â  Â  Â  autocomplete="off">
Â  Â  Â  <div id="autocompleteList" class="autocomplete-list" style="display: none;"></div>
Â  Â  </div>

Â  Â  <hr>

Â  Â  <h3>Selection</h3>
Â  Â  <div id="resultDisplay" class="result-box" style="display: none;"></div>

Â  Â  <label for="qtyInput" class="label-style">2. QTY (Input) :</label>
Â  Â  <input
Â  Â  Â  type="number"
Â  Â  Â  id="qtyInput"
Â  Â  Â  placeholder="Quantity"
Â  Â  Â  inputmode="decimal">

Â  Â  <label for="totalInput" class="label-style">3. TOTAL (Input) :</label>
Â  Â  <input
Â  Â  Â  type="number"
Â  Â  Â  id="totalInput"
Â  Â  Â  placeholder="Total Amount"
Â  Â  Â  inputmode="decimal">

Â  Â  <button onclick="addItemToCart()" id="addButton" disabled>Add to Cart</button>

Â  Â  <hr>

Â  Â  <h3>Local Cart (<span id="cartCount">0</span> Items)</h3>
Â  Â  <div id="localCartDisplay" class="cart-box"></div>

Â  Â  <button onclick="viewLocalCartHTML()" id="viewBillButton" disabled>
Â  Â  Â  View Bill (On Screen)
Â  Â  </button>
Â  Â  <button onclick="downloadLocalCartXLSX()" id="downloadXLSXButton" disabled>
Â  Â  Â  Download Cart as XLSX
Â  Â  </button>
Â  Â  
Â  Â  <button onclick="clearLocalCart()" style="background-color: #f44336; margin-top: 10px;">
Â  Â  Â  Clear Local Cart / New Invoice
Â  Â  </button>


Â  Â  <p id="message">Loading data ...</p>
Â  </div>
Â Â 
Â  <div id="billViewArea" class="container" style="display: none; max-width: 90%; margin-top: 20px;">
Â  Â  <h3>Generated Bill Preview</h3>
Â  Â  <div id="billContent"></div>
Â  </div>


Â  <script>
Â  Â  // CONFIG
Â  Â  const CART_STORAGE_KEY = 'kmartLocalCart';
Â  Â  const TEMPLATE_FILE = './template.xlsx'; // Path to your template file

Â  Â  // STATE
Â  Â  let allItemData = [];
Â  Â  let selectedItem = null;

Â  Â  // --- LOCAL STORAGE UTILITIES (Unchanged) ---
Â  Â  function loadLocalCart() {
Â  Â  Â  const storedCart = localStorage.getItem(CART_STORAGE_KEY);
Â  Â  Â  return storedCart ? JSON.parse(storedCart) : {};
Â  Â  }

Â  Â  function saveLocalCart(cartData) {
Â  Â  Â  localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cartData));
Â  Â  }

Â  Â  // --- INITIAL LOAD (Unchanged) ---
Â  Â  async function loadItemData() {
Â  Â  Â  try {
Â  Â  Â  Â  // NOTE: This assumes 'items.json' exists alongside this HTML file
Â  Â  Â  Â  const itemResponse = await fetch('./items.json'); 
Â  Â  Â  Â  allItemData = await itemResponse.json();

Â  Â  Â  Â  // Check if template exists
Â  Â  Â  Â  const checkTemplate = await fetch(TEMPLATE_FILE, { method: 'HEAD' });
Â  Â  Â  Â  if (!checkTemplate.ok) {
Â  Â  Â  Â  Â  Â  document.getElementById('message').textContent = 'Error: template.xlsx not found!';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('message').textContent = 'Data loaded. Template ready.';
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Error loading JSON files or template:", e);
Â  Â  Â  Â  document.getElementById('message').textContent =
Â  Â  Â  Â  Â  'Error loading item data or template. Check files.';
Â  Â  Â  }
Â  Â  Â  renderCart();
Â  Â  }
Â  Â Â 
Â  Â  // --- SEARCH AND SELECTION LOGIC (Unchanged) ---
Â  Â  function handleSearchInput() {
Â  Â  Â  const searchInput = document.getElementById('searchInput');
Â  Â  Â  const listDiv = document.getElementById('autocompleteList');
Â  Â  Â  const messageEl = document.getElementById('message');
Â  Â  Â  const searchText = searchInput.value.trim().toLowerCase();

Â  Â  Â  selectedItem = null;
Â  Â  Â  document.getElementById('resultDisplay').style.display = 'none';
Â  Â  Â  document.getElementById('addButton').disabled = true;

Â  Â  Â  listDiv.style.display = 'none';
Â  Â  Â  listDiv.innerHTML = "";

Â  Â  Â  if (searchText.length < 3) {
Â  Â  Â  Â  messageEl.textContent = 'Type at least 3 characters.';
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  const searchParts = searchText.split(/\s+/).filter(p => p.length > 0);
Â  Â  Â  const results = [];

Â  Â  Â  for (const data of allItemData) {
Â  Â  Â  Â  const itemName = (data.item || "").toLowerCase();
Â  Â  Â  Â  const code = String(data.code || "");
Â  Â  Â  Â  const combined = `${itemName} ${code}`;

Â  Â  Â  Â  const match = searchParts.every(part => combined.includes(part));
Â  Â  Â  Â  if (match) {
Â  Â  Â  Â  Â  results.push(data);
Â  Â  Â  Â  Â  if (results.length >= 20) break;
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  if (results.length > 0) {
Â  Â  Â  Â  results.forEach(suggestion => {
Â  Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  Â  div.className = 'autocomplete-item';
Â  Â  Â  Â  Â  div.innerHTML = `<strong>${suggestion.code}</strong> - ${suggestion.item}`;
Â  Â  Â  Â  Â  div.onclick = () => {
Â  Â  Â  Â  Â  Â  searchInput.value = `${suggestion.code} ${suggestion.item}`;
Â  Â  Â  Â  Â  Â  selectedItem = suggestion;
Â  Â  Â  Â  Â  Â  listDiv.style.display = 'none';
Â  Â  Â  Â  Â  Â  showSelectedItem();
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  listDiv.appendChild(div);
Â  Â  Â  Â  });
Â  Â  Â  Â  listDiv.style.display = 'block';
Â  Â  Â  }

Â  Â  Â  messageEl.textContent = `Found ${results.length} items.`;
Â  Â  }

Â  Â  function showSelectedItem() {
Â  Â  Â  if (selectedItem) {
Â  Â  Â  Â  const display = document.getElementById('resultDisplay');
Â  Â  Â  Â  display.innerHTML = `CODE: ${selectedItem.code} | ITEM: ${selectedItem.item}`;
Â  Â  Â  Â  display.style.display = 'block';

Â  Â  Â  Â  document.getElementById('addButton').disabled = false;
Â  Â  Â  Â  document.getElementById('message').textContent = 'Item Selected. Enter Qty/Total.';
Â  Â  Â  }
Â  Â  }

Â  Â  // --- LOCAL CART LOGIC (Unchanged) ---
Â  Â  function renderCart() {
Â  Â  Â  const localCart = loadLocalCart();
Â  Â  Â  const items = Object.values(localCart);
Â  Â  Â  const cartDisplay = document.getElementById('localCartDisplay');
Â  Â  Â  const cartCount = document.getElementById('cartCount');
Â  Â  Â  const downloadButton = document.getElementById('downloadXLSXButton');
Â  Â  Â  const viewBillButton = document.getElementById('viewBillButton');

Â  Â  Â  cartCount.textContent = items.length;
Â  Â  Â  downloadButton.disabled = (items.length === 0);
Â  Â  Â  viewBillButton.disabled = (items.length === 0); // Enable/Disable View Bill button

Â  Â  Â  if (items.length === 0) {
Â  Â  Â  Â  document.getElementById('billViewArea').style.display = 'none'; // Hide bill if cart is empty
Â  Â  Â  Â  cartDisplay.innerHTML = 'Cart is empty. Add items above.';
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  cartDisplay.innerHTML = "";
Â  Â  Â  items.forEach(item => {
Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  div.className = 'cart-item';
Â  Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  Â  <span>${item.item} (Row: ${item.row})</span>
Â  Â  Â  Â  Â  <span>Qty: ${item.qty} | Total: ${item.total}</span>
Â  Â  Â  Â  `;
Â  Â  Â  Â  cartDisplay.appendChild(div);
Â  Â  Â  });
Â  Â  }
Â  Â  
Â  Â  // --- NEW FUNCTION: CLEAR CART ---
Â  Â  function clearLocalCart() {
Â  Â  Â  if (confirm("Are you sure you want to clear the entire cart and start a new invoice?")) {
Â  Â  Â  Â  localStorage.removeItem(CART_STORAGE_KEY);
Â  Â  Â  Â  renderCart();
Â  Â  Â  Â  document.getElementById('message').textContent = 'Cart cleared. Ready for new invoice.';
Â  Â  Â  Â  document.getElementById('searchInput').value = '';
Â  Â  Â  Â  document.getElementById('qtyInput').value = '';
Â  Â  Â  Â  document.getElementById('totalInput').value = '';
Â  Â  Â  Â  document.getElementById('resultDisplay').style.display = 'none';
Â  Â  Â  Â  document.getElementById('billViewArea').style.display = 'none';
Â  Â  Â  }
Â  Â  }


Â  Â  function addItemToCart() {
Â  Â  Â  if (!selectedItem) {
Â  Â  Â  Â  alert('Please select an item first.');
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  const qtyStr = document.getElementById('qtyInput').value.trim();
Â  Â  Â  const totalStr = document.getElementById('totalInput').value.trim();

Â  Â  Â  const numQty = parseFloat(qtyStr);
Â  Â  Â  const numTotal = parseFloat(totalStr);

Â  Â  Â  if (isNaN(numQty) || isNaN(numTotal) || numQty <= 0) {
Â  Â  Â  Â  alert('Please enter valid QTY and TOTAL values.');
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  const localCart = loadLocalCart();

Â  Â  Â  const cartItem = {
Â  Â  Â  Â  row: selectedItem.row,
Â  Â  Â  Â  qty: numQty,
Â  Â  Â  Â  total: numTotal,
Â  Â  Â  Â  item: selectedItem.item
Â  Â  Â  };

Â  Â  Â  localCart[selectedItem.row] = cartItem;
Â  Â  Â  saveLocalCart(localCart);

Â  Â  Â  document.getElementById('qtyInput').value = "";
Â  Â  Â  document.getElementById('totalInput').value = "";
Â  Â  Â  document.getElementById('searchInput').value = "";
Â  Â  Â  document.getElementById('resultDisplay').style.display = 'none';
Â  Â  Â  document.getElementById('addButton').disabled = true;
Â  Â  Â  selectedItem = null;

Â  Â  Â  renderCart();
Â  Â  Â  document.getElementById('message').textContent =
Â  Â  Â  Â  `Item added to local storage. (${cartItem.item})`;
Â  Â  }

Â  Â  // -------------------------------------------------------------------
Â  Â  // âœ… FUNCTION: VIEW BILL (ON SCREEN) (Unchanged)
Â  Â  // -------------------------------------------------------------------
Â  Â  function viewLocalCartHTML() {
Â  Â  Â  Â  const localCart = loadLocalCart();
Â  Â  Â  Â  const items = Object.values(localCart);
Â  Â  Â  Â  const billViewArea = document.getElementById('billViewArea');
Â  Â  Â  Â  const billContent = document.getElementById('billContent');
Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (items.length === 0) {
Â  Â  Â  Â  Â  Â  billContent.innerHTML = "<p>Cart is empty. Add items to view the bill.</p>";
Â  Â  Â  Â  Â  Â  billViewArea.style.display = 'block';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  let tableHTML = `
Â  Â  Â  Â  Â  Â  <table class="bill-table">
Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>CODE</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="item-name">ITEM NAME</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>QTY</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Rate</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>RATE.inc</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>TOTAL</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>ItemBarCode</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  `;
Â  Â  Â  Â Â 
Â  Â  Â  Â  let grandTotal = 0;
Â  Â  Â  Â Â 
Â  Â  Â  Â  items.forEach((item) => {
Â  Â  Â  Â  Â  Â  const itemDetails = allItemData.find((d) => d.row === item.row);
Â  Â  Â  Â  Â  Â  const itemCode = itemDetails ? String(itemDetails.code || "") : "";
Â  Â  Â  Â  Â  Â  // Barcode calculation based on your provided screenshot pattern: 9900 + CODE + 000000
Â  Â  Â  Â  Â  Â  const paddedCode = itemCode.padStart(4, '0'); // Assuming code is up to 4 digits for this pattern
Â  Â  Â  Â  Â  Â  const itemBarcode = itemCode ? `9900${paddedCode}000000` : "";

Â  Â  Â  Â  Â  Â  const qty = item.qty;
Â  Â  Â  Â  Â  Â  const total = item.total;
Â  Â  Â  Â  Â  Â  const rateInc = qty > 0 ? total / qty : 0;Â 
Â  Â  Â  Â  Â  Â  const rateExcl = rateInc / 1.05; // Assuming a standard 5% VAT or similar inclusion

Â  Â  Â  Â  Â  Â  grandTotal += total;

Â  Â  Â  Â  Â  Â  tableHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${itemCode}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="item-name">${item.item}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${qty.toFixed(2)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${rateExcl.toFixed(3)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${rateInc.toFixed(3)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${total.toFixed(2)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${itemBarcode}</td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  tableHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  <tr class="total-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td colspan="5" style="text-align: right;">GRAND TOTAL:</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align: center;">${grandTotal.toFixed(2)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td></td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  <br>
Â  Â  Â  Â  Â  Â  <div class="footer-text-html" style="font-size: 18pt;">KMART SUPERMARKET LLC</div>
Â  Â  Â  Â  Â  Â  <div class="footer-text-html">Branch: Burdubai (Al Raffa)</div>
Â  Â  Â  Â  Â  Â  <div class="footer-text-html">Date: ${now.toLocaleDateString("en-GB")}</div>
Â  Â  Â  Â  Â  Â  <div class="footer-text-html">Vegetable and Fruits Invoice</div>
Â  Â  Â  Â  `;

Â  Â  Â  Â  billContent.innerHTML = tableHTML;
Â  Â  Â  Â  billViewArea.style.display = 'block';
Â  Â  Â  Â  document.getElementById('message').textContent = 'Bill displayed below.';
Â  Â  }


Â  Â  // -------------------------------------------------------------------
Â  Â  // âœ… UTILITY FUNCTION: MOVES AND UPDATES GRAND TOTAL ROW
Â  Â  // -------------------------------------------------------------------
Â  Â  function moveGrandTotalRow(ws, itemsCount) {
Â  Â  Â  Â  // The original Grand Total row in the template is assumed to be Row 3 (1-indexed)
Â  Â  Â  Â  const originalGtRowIndex = 2; // 0-indexed row number (Row 3 in Excel)
Â  Â  Â  Â  // The new Grand Total row will be immediately after the last data row (Row 2 + itemsCount)
Â  Â  Â  Â  const newGtRowIndex = 1 + itemsCount + 1; // 0-indexed row number (Row index 1 is Row 2 in Excel)
Â  Â  Â  Â  const finalGtAddress = `F${newGtRowIndex + 1}`; // F column, 1-indexed row for the formula

Â  Â  Â  Â  if (itemsCount === 0) return;

Â  Â  Â  Â  // Define the range of cells to move (A3:G3)
Â  Â  Â  Â  const colsToMove = ['A', 'B', 'C', 'D', 'E', 'F', 'G'];

Â  Â  Â  Â  // 1. Copy cells from the original row (Row 3) to the new row
Â  Â  Â  Â  colsToMove.forEach(col => {
Â  Â  Â  Â  Â  Â  const originalCellAddress = col + (originalGtRowIndex + 1);
Â  Â  Â  Â  Â  Â  const newCellAddress = col + (newGtRowIndex + 1);

Â  Â  Â  Â  Â  Â  const originalCell = ws[originalCellAddress];
Â  Â  Â  Â  Â  Â  if (originalCell) {
Â  Â  Â  Â  Â  Â  Â  Â  // Deep copy the cell object to the new location
Â  Â  Â  Â  Â  Â  Â  Â  ws[newCellAddress] = JSON.parse(JSON.stringify(originalCell));
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Ensure target cell is empty if source was empty
Â  Â  Â  Â  Â  Â  Â  Â  delete ws[newCellAddress];
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // 2. Clear the original Grand Total row's cells (A3:G3)
Â  Â  Â  Â  colsToMove.forEach(col => {
Â  Â  Â  Â  Â  Â  const originalCellAddress = col + (originalGtRowIndex + 1);
Â  Â  Â  Â  Â  Â  delete ws[originalCellAddress];
Â  Â  Â  Â  });

Â  Â  Â  Â  // 3. Update the Grand Total Formula in the new location (F column)
Â  Â  Â  Â  if (ws[finalGtAddress]) {
Â  Â  Â  Â  Â  Â  // The data ends at row 'lastDataRowExcel' (1-indexed Excel row is 1 + itemsCount)
Â  Â  Â  Â  Â  Â  const lastDataRowExcel = 1 + itemsCount;
Â  Â  Â  Â  Â  Â  // Formula is SUM(F2:F_lastDataRow)
Â  Â  Â  Â  Â  Â  ws[finalGtAddress].f = `SUM(F2:F${lastDataRowExcel})`;
Â  Â  Â  Â  Â  Â  // Force the type to 'n' and apply the proper format for a total
Â  Â  Â  Â  Â  Â  ws[finalGtAddress].t = 'n';
Â  Â  Â  Â  Â  Â  ws[finalGtAddress].z = "#,##0.00";
Â  Â  Â  Â  }

Â  Â  Â  Â  // 4. Update the worksheet's dimensions to include the new row
Â  Â  Â  Â  const range = XLSX.utils.decode_range(ws['!ref']);
Â  Â  Â  Â  if (newGtRowIndex > range.e.r) {
Â  Â  Â  Â  Â  Â  range.e.r = newGtRowIndex;
Â  Â  Â  Â  Â  Â  ws['!ref'] = XLSX.utils.encode_range(range);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 5. Update Merges for the Grand Total row (A to E)
Â  Â  Â  Â  const mergeRange = `A${newGtRowIndex + 1}:E${newGtRowIndex + 1}`;
Â  Â  Â  Â  if (!ws['!merges']) ws['!merges'] = [];
Â  Â  Â  Â  ws['!merges'].push(XLSX.utils.decode_range(mergeRange));

Â  Â  Â  Â  // 6. Remove the old merge (A3:E3)
Â  Â  Â  Â  const oldMergeRange = `A${originalGtRowIndex + 1}:E${originalGtRowIndex + 1}`;
Â  Â  Â  Â  const oldMergeIndex = ws['!merges'].findIndex(m => {
Â  Â  Â  Â  Â  Â  const encoded = XLSX.utils.encode_range(m);
Â  Â  Â  Â  Â  Â  return encoded === oldMergeRange;
Â  Â  Â  Â  });
Â  Â  Â  Â  if (oldMergeIndex > -1) {
Â  Â  Â  Â  Â  Â  ws['!merges'].splice(oldMergeIndex, 1);
Â  Â  Â  Â  }
Â  Â  }


Â  Â  // -------------------------------------------------------------------
Â  Â  // âœ… TEMPLATE-BASED DOWNLOAD FUNCTION (WITH FIX)
Â  Â  // -------------------------------------------------------------------
Â  Â  async function downloadLocalCartXLSX() {
Â  Â  Â  Â  const XLSX = window.XLSX;Â 

Â  Â  Â  Â  if (!XLSX) {
Â  Â  Â  Â  alert("XLSX library not loaded");
Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const localCart = loadLocalCart();
Â  Â  Â  Â  const items = Object.values(localCart);
Â  Â  Â  Â  if (items.length === 0) {
Â  Â  Â  Â  alert("Cart is empty");
Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // 1. Fetch the template file
Â  Â  Â  Â  let rawData;
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch(TEMPLATE_FILE);
Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Failed to fetch template: ${response.statusText}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  rawData = await response.arrayBuffer();
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  alert("Error loading template.xlsx. Please ensure the file exists and is uploaded as a proper XLSX file.");
Â  Â  Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // 2. Read the template Workbook
Â  Â  Â  Â  const wb = XLSX.read(rawData, { type: 'array' });
Â  Â  Â  Â  const sheetName = wb.SheetNames[0];Â 
Â  Â  Â  Â  const ws = wb.Sheets[sheetName];

Â  Â  Â  Â  // 3. Prepare the new data
Â  Â  Â  Â  const dataRows = [];
Â  Â  Â  Â  const now = new Date();

Â  Â  Â  Â  items.forEach((item) => {
Â  Â  Â  Â  const itemDetails = allItemData.find((d) => d.row === item.row);
Â  Â  Â  Â  const itemCode = itemDetails ? String(itemDetails.code || "") : "";
Â  Â  Â  Â  // Barcode calculation logic: 9900 + padded CODE + 000000
Â  Â  Â  Â  const paddedCode = itemCode.padStart(4, '0');
Â  Â  Â  Â  const itemBarcode = itemCode ? `9900${paddedCode}000000` : "";

Â  Â  Â  Â  const qty = item.qty;
Â  Â  Â  Â  const total = item.total;
Â  Â  Â  Â  const rateInc = qty > 0 ? total / qty : 0;Â 
Â  Â  Â  Â  const rateExcl = rateInc / 1.05;

Â  Â  Â  Â  // Ensure the order matches the template's columns (A-G)
Â  Â  Â  Â  dataRows.push([
Â  Â  Â  Â  Â  Â  itemCode,
Â  Â  Â  Â  Â  Â  item.item,
Â  Â  Â  Â  Â  Â  qty,
Â  Â  Â  Â  Â  Â  { v: Number(rateExcl.toFixed(3)), t: "n", z: "0.000" },
Â  Â  Â  Â  Â  Â  { v: Number(rateInc.toFixed(3)), t: "n", z: "0.000" },
Â  Â  Â  Â  Â  Â  { v: total, t: "n", z: "#,##0.00" },
Â  Â  Â  Â  Â  Â  itemBarcode
Â  Â  Â  Â  ]);
Â  Â  Â  Â  });

Â  Â  Â  Â  // 4. Add new data to the worksheet starting from A2
Â  Â  Â  Â  XLSX.utils.sheet_add_aoa(
Â  Â  Â  Â  Â  Â  ws,Â 
Â  Â  Â  Â  Â  Â  dataRows,Â 
Â  Â  Â  Â  Â  Â  {Â 
Â  Â  Â  Â  Â  Â  Â  Â  origin: "A2",Â 
Â  Â  Â  Â  Â  Â  Â  Â  skipHeader: true,Â 
Â  Â  Â  Â  Â  Â  Â  Â  cellStyles: true // Retains styles from template (Row 2 styles the data)
Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  );Â 

Â  Â  Â  Â  // 5. DEFINE AND APPLY ROBUST STYLE FOR NEW DATA ROWS
Â  Â  Â  Â  const startRow = 2;Â 
Â  Â  Â  Â  const lastDataRow = 1 + items.length; // The last row number of the inserted data

Â  Â  Â  Â  // Define a base style object (16pt font)
Â  Â  Â  Â  const baseCellStyle = {
Â  Â  Â  Â  Â  Â  font: { sz: 16, name: "Arial" },Â 
Â  Â  Â  Â  Â  Â  alignment: { vertical: "center" }
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Ensure row objects exist for height setting
Â  Â  Â  Â  if (!ws['!rows']) ws['!rows'] = [];


Â  Â  Â  Â  for (let r = startRow; r <= lastDataRow; r++) {
Â  Â  Â  Â  Â  Â  const rowIdx = r - 1; // 0-indexed row number
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // ðŸŽ¯ Force Row Height (22 points for size 16 font)
Â  Â  Â  Â  Â  Â  if (!ws['!rows'][rowIdx]) ws['!rows'][rowIdx] = {};
Â  Â  Â  Â  Â  Â  ws['!rows'][rowIdx].hpt = 22;Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  for (let c = 0; c <= 6; c++) {
Â  Â  Â  Â  Â  Â  Â  Â  const cellAddress = XLSX.utils.encode_cell({ r: rowIdx, c: c });
Â  Â  Â  Â  Â  Â  Â  Â  const cell = ws[cellAddress];

Â  Â  Â  Â  Â  Â  Â  Â  if (cell) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Create a style object based on the base style
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let currentStyle = JSON.parse(JSON.stringify(baseCellStyle));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Apply specific number formats and horizontal alignment based on column
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (c === 0 || c === 2 || c === 6) { // CODE, QTY, BarCode
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentStyle.alignment.horizontal = "center";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (c === 1) { // ITEM NAME
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentStyle.alignment.horizontal = "left";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else { // Rates & Total
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentStyle.alignment.horizontal = "center";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Number formats (Rates & Total) - Use 'z' (format string) if it exists
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (cell.t === 'n') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (c === 3 || c === 4) { // Rate/Rate.inc
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentStyle.numFmt = "0.000";Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (c === 5) { // Total
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentStyle.numFmt = "#,##0.00";Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Use the default number format set by the template if available
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentStyle.numFmt = cell.z || "General";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  delete currentStyle.numFmt;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Assign the constructed style object to the cell
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cell.s = currentStyle;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }


Â  Â  Â  Â  // 6. MOVE AND UPDATE GRAND TOTAL ROW (THE FIX)
Â  Â  Â  Â  moveGrandTotalRow(ws, items.length);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 7. Write/Download the new file
Â  Â  Â  Â  const filename =
Â  Â  Â  Â  `INVOICE_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, "0")}${String(now.getDate()).padStart(2, "0")}_${String(now.getHours()).padStart(2, "0")}${String(now.getMinutes()).padStart(2, "0")}.xlsx`;

Â  Â  Â  Â  XLSX.writeFile(wb, filename);
Â  Â  Â  Â  document.getElementById('message').textContent = `Downloaded: ${filename}. Please check if the final styling has applied.`;
Â  Â  }
Â  </script>
</body>
</html>
