<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Shop Invoice - kmart alraffa (Offline Cart)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f4; }
    .container { max-width: 400px; margin: auto; background: white; padding: 20px;
      border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
    input[type="text"], input[type="number"] { width: 100%; padding: 10px; margin-bottom: 15px;
      border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
    button { width: 100%; padding: 10px; color: white; border: none; border-radius: 4px; 
      cursor: pointer; font-size: 16px; margin-bottom: 15px; }
    button:hover:enabled { opacity: 0.9; }
    button:disabled { background-color: #cccccc !important; cursor: not-allowed; }
    h1 { text-align: center; color: #333; margin-bottom: 5px; }
    h2 { text-align: center; color: #666; margin-top: 0; margin-bottom: 20px; font-size: 18px; }
    .result-box { background-color: #e0f7fa; padding: 10px; border-radius: 4px; margin-bottom: 20px; font-weight: bold; }
    .cart-box { background-color: #fff3e0; padding: 10px; border-radius: 4px; margin-bottom: 20px; }
    .search-area { position: relative; }
    .autocomplete-list { border: 1px solid #ccc; max-height: 200px; overflow-y: auto;
      position: absolute; width: 100%; background: white; z-index: 10; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
    .autocomplete-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
    .autocomplete-item:hover { background-color: #f0f0f0; }
    .label-style { font-weight: bold; margin-bottom: 5px; display: block; }

    /* Buttons */
    #addButton { background-color: #4CAF50; }
    #downloadXLSXButton { background-color: #007bff; margin-bottom: 15px;}
    
    .cart-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #ccc; font-size: 14px; }
    .cart-item:last-child { border-bottom: none; }
  </style>
</head>
<body onload="loadItemData()">

  <div class="container">
    <h1>Shop Invoice</h1>
    <h2>kmart alraffa</h2>

    <hr>

    <div class="search-area">
      <label for="searchInput" class="label-style">1. ITEM CODE OR NAME:</label>
      <input
        type="text"
        id="searchInput"
        placeholder="Type to search and click an item"
        onkeyup="handleSearchInput()"
        autocomplete="off">

      <div id="autocompleteList" class="autocomplete-list" style="display: none;"></div>
    </div>

    <hr>

    <h3>Selection</h3>
    <div id="resultDisplay" class="result-box" style="display: none;"></div>

    <label for="qtyInput" class="label-style">2. QTY (Input):</label>
    <input
      type="number"
      id="qtyInput"
      placeholder="Quantity"
      inputmode="decimal">

    <label for="totalInput" class="label-style">3. TOTAL (Input):</label>
    <input
      type="number"
      id="totalInput"
      placeholder="Total Amount"
      inputmode="decimal">

    <button onclick="addItemToCart()" id="addButton" disabled>Add to Cart</button>

    <hr>
    
    <h3>Local Cart (<span id="cartCount">0</span> Items)</h3>
    <div id="localCartDisplay" class="cart-box">
      </div>

    <button onclick="downloadLocalCartXLSX()" id="downloadXLSXButton" disabled>
      Download Cart as XLSX
    </button>
    
    <p id="message">Loading data ...</p>
  </div>

  <script>
    // CONFIG:
    const CART_STORAGE_KEY = 'kmartLocalCart'; 

    // STATE
    let allItemData = [];
    let selectedItem = null;
    
    // --- LOCAL STORAGE UTILITIES ---
    function loadLocalCart() {
        const storedCart = localStorage.getItem(CART_STORAGE_KEY);
        return storedCart ? JSON.parse(storedCart) : {}; 
    }

    function saveLocalCart(cartData) {
        localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cartData));
    }


    // --- UTILITIES & INITIAL LOAD ---

    async function loadItemData() {
      try {
        const response = await fetch('./items.json'); 
        allItemData = await response.json();
        document.getElementById('message').textContent = 'Data loaded successfully. Ready.';
      } catch (e) {
        console.error("Error loading items.json:", e);
        document.getElementById('message').textContent = 'Error loading item data. Check items.json file.';
      }
      renderCart();
    }

    // --- SEARCH AND SELECTION LOGIC ---
    function handleSearchInput() {
      const searchInput = document.getElementById('searchInput');
      const listDiv = document.getElementById('autocompleteList');
      const messageEl = document.getElementById('message');
      const searchText = searchInput.value.trim().toLowerCase();

      selectedItem = null;
      document.getElementById('resultDisplay').style.display = 'none';
      document.getElementById('addButton').disabled = true;

      listDiv.style.display = 'none';
      listDiv.innerHTML = '';

      if (searchText.length < 3) {
        messageEl.textContent = 'Type at least 3 characters.';
        return;
      }

      const searchParts = searchText.split(/\s+/).filter(p => p.length > 0);
      const results = [];

      for (const data of allItemData) {
        const itemName = (data.item || '').toLowerCase();
        const code = String(data.code || '');
        const combined = `${itemName} ${code}`;
        const match = searchParts.every(part => combined.includes(part));
        if (match) {
          results.push(data);
          if (results.length >= 20) break;
        }
      }

      if (results.length > 0) {
        results.forEach(suggestion => {
          const div = document.createElement('div');
          div.className = 'autocomplete-item';
          div.innerHTML = `<strong>${suggestion.code}</strong> - ${suggestion.item}`;
          div.onclick = () => {
            searchInput.value = `${suggestion.code} ${suggestion.item}`;
            selectedItem = suggestion;
            listDiv.style.display = 'none';
            showSelectedItem();
          };
          listDiv.appendChild(div);
        });
        listDiv.style.display = 'block';
      }
      messageEl.textContent = `Found ${results.length} items.`;
    }

    function showSelectedItem() {
      if (selectedItem) {
        document.getElementById('resultDisplay').innerHTML = `CODE: ${selectedItem.code} | ITEM: ${selectedItem.item}`;
        document.getElementById('resultDisplay').style.display = 'block';
        document.getElementById('addButton').disabled = false;
        document.getElementById('message').textContent = 'Item Selected. Enter Qty/Total.';
      }
    }
    
    // --- LOCAL CART LOGIC ---
    
    function renderCart() {
        const localCart = loadLocalCart(); 
        const items = Object.values(localCart);
        const cartDisplay = document.getElementById('localCartDisplay');
        const cartCount = document.getElementById('cartCount');
        const downloadButton = document.getElementById('downloadXLSXButton'); 
        
        cartCount.textContent = items.length;
        downloadButton.disabled = items.length === 0;

        if (items.length === 0) {
            cartDisplay.innerHTML = 'Cart is empty. Add items above.';
            return;
        }

        cartDisplay.innerHTML = '';
        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'cart-item';
            div.innerHTML = `
                <span>${item.item} (${item.row})</span>
                <span>Qty: ${item.qty} | Total: ${item.total}</span>
            `;
            cartDisplay.appendChild(div);
        });
    }

    function addItemToCart() {
        if (!selectedItem) {
            alert('Please select an item first.');
            return;
        }

        const qty = document.getElementById('qtyInput').value.trim();
        const total = document.getElementById('totalInput').value.trim();
        const numQty = parseFloat(qty);
        const numTotal = parseFloat(total);

        if (isNaN(numQty) || isNaN(numTotal) || numQty <= 0) {
            alert('Please enter valid QTY and TOTAL values.');
            return;
        }
        
        const localCart = loadLocalCart(); 

        const cartItem = {
            row: selectedItem.row,
            qty: numQty,
            total: numTotal,
            item: selectedItem.item 
        };
        
        localCart[selectedItem.row] = cartItem;
        
        saveLocalCart(localCart); 

        // Reset inputs and selection
        document.getElementById('qtyInput').value = '';
        document.getElementById('totalInput').value = '';
        document.getElementById('searchInput').value = '';
        document.getElementById('resultDisplay').style.display = 'none';
        document.getElementById('addButton').disabled = true;
        selectedItem = null;
        
        renderCart();
        document.getElementById('message').textContent = `Item added to local storage. (${cartItem.item})`;
    }

    // --- NEW: DOWNLOAD XLSX LOGIC (Excel File - Invoice Format) ---

    function downloadLocalCartXLSX() {
        const localCart = loadLocalCart();
        const items = Object.values(localCart);
        
        if (items.length === 0) {
            alert('Cart is empty. Nothing to download.');
            return;
        }

        // ‡¥µ‡µº‡¥ï‡µç‡¥ï‡µç‡¥∑‡µÄ‡¥±‡µç‡¥±‡¥ø‡¥®‡¥æ‡¥Ø‡µÅ‡¥≥‡µç‡¥≥ ‡¥°‡¥æ‡¥±‡µç‡¥±‡¥æ ‡¥í‡¥∞‡µÅ Array of Arrays ‡¥Ü‡¥Ø‡¥ø ‡¥§‡¥Ø‡µç‡¥Ø‡¥æ‡¥±‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
        // üö® ‡¥á‡µª‡¥µ‡µã‡¥Ø‡µç‡¥∏‡µç ‡¥´‡µã‡µº‡¥Æ‡¥æ‡¥±‡µç‡¥±‡µç ‡¥Ö‡¥®‡µÅ‡¥∏‡¥∞‡¥ø‡¥ö‡µç‡¥ö‡µç Header ‡¥Æ‡¥æ‡¥±‡µç‡¥±‡µÅ‡¥®‡µç‡¥®‡µÅ
        const ws_data = [
            ['CODE', 'ITEM NAME', 'QTY', 'Rate', 'RATE.inc', 'TOTAL']
        ];
        
        // ‡¥ì‡¥∞‡µã ‡¥á‡¥®‡¥µ‡µÅ‡¥Ç ‡¥°‡¥æ‡¥±‡µç‡¥±‡¥æ ‡¥µ‡¥∞‡¥ø‡¥ï‡¥≥‡¥æ‡¥Ø‡¥ø ‡¥ö‡µá‡µº‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
        items.forEach(item => {
            const itemDetails = allItemData.find(d => d.row === item.row);
            const itemCode = itemDetails ? itemDetails.code : '';
            
            const qty = item.qty;
            const total = item.total;
            
            let rateInc = 0; // Tax ‡¥â‡µæ‡¥™‡µç‡¥™‡µÜ‡¥ü‡µÜ‡¥Ø‡µÅ‡¥≥‡µç‡¥≥ ‡¥®‡¥ø‡¥∞‡¥ï‡µç‡¥ï‡µç
            let rateExcl = 0; // Tax ‡¥á‡¥≤‡µç‡¥≤‡¥æ‡¥§‡µç‡¥§ ‡¥®‡¥ø‡¥∞‡¥ï‡µç‡¥ï‡µç
            
            if (qty > 0) {
                rateInc = total / qty;
                // 5% VAT (‡¥∏‡¥æ‡¥ß‡¥æ‡¥∞‡¥£ ‡¥ó‡µæ‡¥´‡µç ‡¥∞‡¥æ‡¥ú‡µç‡¥Ø‡¥ô‡µç‡¥ô‡¥≥‡¥ø‡¥≤‡µÜ ‡¥®‡¥ø‡¥ï‡µÅ‡¥§‡¥ø) ‡¥Ö‡¥®‡µÅ‡¥∏‡¥∞‡¥ø‡¥ö‡µç‡¥ö‡µç Rate (Tax Exclusive) ‡¥ï‡¥£‡¥ï‡µç‡¥ï‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
                // IFERROR ‡¥®‡µç ‡¥∏‡¥Æ‡¥æ‡¥®‡¥Æ‡¥æ‡¥Ø‡¥ø 0 ‡¥µ‡¥∞‡¥æ‡µª if/else ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
                rateExcl = rateInc / 1.05; 
            }

            ws_data.push([
                itemCode, // CODE
                item.item, // ITEM NAME
                qty,       // QTY
                parseFloat(rateExcl.toFixed(3)), // Rate (3 ‡¥¶‡¥∂‡¥æ‡¥Ç‡¥∂‡¥Ç)
                parseFloat(rateInc.toFixed(3)),  // RATE.inc (3 ‡¥¶‡¥∂‡¥æ‡¥Ç‡¥∂‡¥Ç)
                total      // TOTAL
            ]);
        });

        // 1. ‡¥µ‡µº‡¥ï‡µç‡¥ï‡µç‡¥∑‡µÄ‡¥±‡µç‡¥±‡µç ‡¥â‡¥£‡µç‡¥ü‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        
        // 2. ‡¥µ‡µº‡¥ï‡µç‡¥ï‡µç‡¥¨‡µÅ‡¥ï‡µç‡¥ï‡µç ‡¥â‡¥£‡µç‡¥ü‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "INVOICE"); // ‡¥∑‡µÄ‡¥±‡µç‡¥±‡¥ø‡µª‡µç‡¥±‡µÜ ‡¥™‡µá‡¥∞‡µç INVOICE ‡¥é‡¥®‡µç‡¥®‡µç ‡¥®‡µΩ‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ

        // 3. ‡¥´‡¥Ø‡µΩ ‡¥°‡µó‡µ∫‡¥≤‡µã‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ
        const now = new Date();
        const filename = `INVOICE_${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}.xlsx`;

        XLSX.writeFile(wb, filename); // XLSX ‡¥≤‡µà‡¥¨‡µç‡¥∞‡¥±‡¥ø ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ö‡µç‡¥ö‡µç ‡¥°‡µó‡µ∫‡¥≤‡µã‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ
        
        document.getElementById('message').textContent = `${items.length} items downloaded as ${filename}.`;
    }

    // --- MASS UPDATE LOGIC (‡¥™‡µÇ‡µº‡¥£‡µç‡¥£‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥®‡µÄ‡¥ï‡µç‡¥ï‡¥Ç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µÅ) ---

  </script>
</body>
</html>
