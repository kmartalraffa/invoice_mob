<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Shop Invoice - kmart alraffa (Offline Cart)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f4f4f4;
    }
    .container {
      max-width: 400px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 16px;
    }
    button {
      width: 100%;
      padding: 10px;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-bottom: 15px;
    }
    button:hover:enabled {
      opacity: 0.9;
    }
    button:disabled {
      background-color: #cccccc !important;
      cursor: not-allowed;
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 5px;
    }
    h2 {
      text-align: center;
      color: #666;
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 18px;
    }
    .result-box {
      background-color: #e0f7fa;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 20px;
      font-weight: bold;
    }
    .cart-box {
      background-color: #fff3e0;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    .search-area {
      position: relative;
    }
    .autocomplete-list {
      border: 1px solid #ccc;
      max-height: 200px;
      overflow-y: auto;
      position: absolute;
      width: 100%;
      background: white;
      z-index: 10;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .autocomplete-item {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .autocomplete-item:hover {
      background-color: #f0f0f0;
    }
    .label-style {
      font-weight: bold;
      margin-bottom: 5px;
      display: block;
    }
    #addButton { background-color: #4CAF50; }
    #downloadXLSXButton { background-color: #007bff; }
    .cart-item {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px dashed #ccc;
      font-size: 14px;
    }
  </style>
</head>

<body onload="loadItemData()">
  <div class="container">
    <h1>Shop Invoice</h1>
    <h2>kmart alraffa</h2>
    <hr>

    <div class="search-area">
      <label class="label-style">1. ITEM CODE OR NAME :</label>
      <input type="text" id="searchInput" placeholder="Type to search" onkeyup="handleSearchInput()" autocomplete="off">
      <div id="autocompleteList" class="autocomplete-list" style="display:none;"></div>
    </div>

    <hr>

    <h3>Selection</h3>
    <div id="resultDisplay" class="result-box" style="display:none;"></div>

    <label class="label-style">2. QTY (Input) :</label>
    <input type="number" id="qtyInput" placeholder="Quantity" inputmode="decimal">

    <label class="label-style">3. TOTAL (Input) :</label>
    <input type="number" id="totalInput" placeholder="Total Amount" inputmode="decimal">

    <button id="addButton" onclick="addItemToCart()" disabled>Add to Cart</button>

    <hr>

    <h3>Local Cart (<span id="cartCount">0</span> Items)</h3>
    <div id="localCartDisplay" class="cart-box"></div>

    <button id="downloadXLSXButton" onclick="downloadLocalCartXLSX()" disabled>Download Cart as XLSX</button>

    <p id="message">Loading data ...</p>
  </div>

<script>
const CART_STORAGE_KEY = 'kmartLocalCart';
let allItemData = [];
let selectedItem = null;

function loadLocalCart() {
  const stored = localStorage.getItem(CART_STORAGE_KEY);
  return stored ? JSON.parse(stored) : {};
}
function saveLocalCart(data) {
  localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(data));
}

async function loadItemData() {
  try {
    const res = await fetch('./items.json');
    allItemData = await res.json();
    document.getElementById('message').textContent = 'Data loaded successfully.';
  } catch {
    document.getElementById('message').textContent = 'Error loading items.json';
  }
  renderCart();
}

function handleSearchInput() {
  const input = document.getElementById('searchInput').value.trim().toLowerCase();
  const list = document.getElementById('autocompleteList');
  const msg = document.getElementById('message');

  selectedItem = null;
  document.getElementById('resultDisplay').style.display = 'none';
  document.getElementById('addButton').disabled = true;

  list.innerHTML = "";
  list.style.display = "none";

  if (input.length < 3) {
    msg.textContent = "Type at least 3 characters.";
    return;
  }

  const parts = input.split(/\s+/);
  const results = [];

  for (const d of allItemData) {
    const name = (d.item || "").toLowerCase();
    const code = String(d.code || "");
    const combined = `${name} ${code}`;
    if (parts.every(p => combined.includes(p))) {
      results.push(d);
      if (results.length >= 20) break;
    }
  }

  results.forEach(r => {
    const div = document.createElement('div');
    div.className = "autocomplete-item";
    div.innerHTML = `<strong>${r.code}</strong> - ${r.item}`;
    div.onclick = () => {
      document.getElementById('searchInput').value = `${r.code} ${r.item}`;
      selectedItem = r;
      list.style.display = "none";
      showSelectedItem();
    };
    list.appendChild(div);
  });

  list.style.display = results.length ? "block" : "none";
  msg.textContent = `Found ${results.length} items.`;
}

function showSelectedItem() {
  const box = document.getElementById('resultDisplay');
  box.innerHTML = `CODE: ${selectedItem.code} | ITEM: ${selectedItem.item}`;
  box.style.display = "block";
  document.getElementById('addButton').disabled = false;
}

function renderCart() {
  const cart = loadLocalCart();
  const items = Object.values(cart);
  const display = document.getElementById('localCartDisplay');
  const count = document.getElementById('cartCount');
  const dlBtn = document.getElementById('downloadXLSXButton');

  count.textContent = items.length;
  dlBtn.disabled = items.length === 0;

  if (!items.length) {
    display.innerHTML = "Cart is empty.";
    return;
  }

  display.innerHTML = "";
  items.forEach(i => {
    const div = document.createElement('div');
    div.className = "cart-item";
    div.innerHTML = `<span>${i.item} (Row ${i.row})</span><span>Qty: ${i.qty} | Total: ${i.total}</span>`;
    display.appendChild(div);
  });
}

function addItemToCart() {
  if (!selectedItem) return alert("Select an item first.");

  const qty = parseFloat(document.getElementById('qtyInput').value);
  const total = parseFloat(document.getElementById('totalInput').value);

  if (isNaN(qty) || isNaN(total) || qty <= 0) {
    return alert("Enter valid QTY and TOTAL.");
  }

  const cart = loadLocalCart();
  cart[selectedItem.row] = {
    row: selectedItem.row,
    qty,
    total,
    item: selectedItem.item
  };

  saveLocalCart(cart);

  document.getElementById('qtyInput').value = "";
  document.getElementById('totalInput').value = "";
  document.getElementById('searchInput').value = "";
  document.getElementById('resultDisplay').style.display = "none";
  document.getElementById('addButton').disabled = true;

  selectedItem = null;
  renderCart();
  document.getElementById('message').textContent = "Item added.";
}

function downloadLocalCartXLSX() {
  const cart = loadLocalCart();
  const items = Object.values(cart);
  if (!items.length) return alert("Cart empty.");

  const now = new Date();
  const date = now.toLocaleDateString('en-GB');

  const ws = XLSX.utils.aoa_to_sheet([]);

  XLSX.utils.sheet_add_aoa(ws, [['KMART SUPERMARKET LLC [AL RAFFA]']], { origin: "A1" });
  XLSX.utils.sheet_add_aoa(ws, [['VEGETABLE AND FRUITS INVOICE']], { origin: "A2" });
  XLSX.utils.sheet_add_aoa(ws, [[date]], { origin: "A3" });

  ws['!merges'] = [
    { s: { r:0, c:0 }, e:{ r:0, c:6 } },
    { s: { r:1, c:0 }, e:{ r:1, c:6 } },
    { s: { r:2, c:0 }, e:{ r:2, c:6 } }
  ];

  ws['A1'].s = { font:{ bold:true, sz:18 }, alignment:{ horizontal:"center" } };
  ws['A2'].s = { font:{ bold:true, sz:10 }, alignment:{ horizontal:"center" } };
  ws['A3'].s = { font:{ bold:true, sz:11 }, alignment:{ horizontal:"center" } };

  XLSX.utils.sheet_add_aoa(ws, [['ITEM NAME','CODE','QTY','RATE','TOTAL']], { origin:"A4" });

  ['A4','B4','C4','D4','E4'].forEach(c=>{
    ws[c].s = {
      font:{ bold:true },
      alignment:{ horizontal:"center" },
      border:{ top:{style:"thin"}, bottom:{style:"thin"}, left:{style:"thin"}, right:{style:"thin"} }
    };
  });

  const rows = [];
  let totalSum = 0;

  items.forEach(i=>{
    const d = allItemData.find(x=>x.row===i.row);
    const code = d ? d.code : "";
    const rate = i.qty > 0 ? (i.total / i.qty).toFixed(2) : 0;
    totalSum += i.total;
    rows.push([i.item, code, i.qty, rate, i.total]);
  });

  XLSX.utils.sheet_add_aoa(ws, rows, { origin:"A5" });

  const start = 5;
  const end = 4 + items.length;

  for (let r=start; r<=end; r++) {
    ws[`A${r}`].s = {
      alignment:{ horizontal:"left" },
      border:{ top:{style:"thin"}, bottom:{style:"thin"}, left:{style:"thin"}, right:{style:"thin"} }
    };
    ['B','C','D','E'].forEach(col=>{
      ws[`${col}${r}`].s = {
        alignment:{ horizontal:"center" },
        border:{ top:{style:"thin"}, bottom:{style:"thin"}, left:{style:"thin"}, right:{style:"thin"} }
      };
    });
  }

  const footer = end + 2;
  XLSX.utils.sheet_add_aoa(ws, [['GRAND TOTAL','','','', totalSum.toFixed(2)]], { origin:`A${footer}` });

  ws[`A${footer}`].s = { font:{ bold:true } };
  ws[`E${footer}`].s = {
    font:{ bold:true },
    alignment:{ horizontal:"center" },
    border:{ top:{style:"medium"}, bottom:{style:"medium"}, left:{style:"medium"}, right:{style:"medium"} }
  };

  ws['!cols'] = [
    { wch:25 }, { wch:10 }, { wch:8 }, { wch:10 }, { wch:12 }
  ];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "INVOICE");

  const filename = `INVOICE_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.xlsx`;

  XLSX.writeFile(wb, filename);
  document.getElementById('message').textContent = "Invoice downloaded.";
}
</script>

</body>
</html>
